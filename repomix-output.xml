This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where empty lines have been removed.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
- Pay special attention to the Repository Description. These contain important context and guidelines specific to this project.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*, **/*
- Files matching these patterns are excluded: node_modules/**, .git/**, dist/**, *.zip, *.log, *.tmp, *.bak, .DS_Store, .aider*, .env, dev/**, repomix-output.xml, repomix.config.json, exceljs.bare.min.js, images/**, screenshot.webp, *.png, *.jpg, *.jpeg, *.gif, *.webp, *.ico, *.svg, node_modules/**, .git/**, dist/**, *.zip, *.log, *.tmp, *.bak, .DS_Store, .aider*, .env, dev/**, repomix-output.xml, repomix.config.json, exceljs.bare.min.js, images/**, screenshot.webp, *.png, *.jpg, *.jpeg, *.gif, *.webp, *.ico, *.svg
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Empty lines have been removed from all files
- Long base64 data strings (e.g., data:image/png;base64,...) have been truncated to reduce token count
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<user_provided_header>
Walmart Invoice Exporter - Chrome Extension for downloading Walmart order invoices as Excel files
</user_provided_header>

<directory_structure>
_locales/
  en/
    messages.json
.github/
  workflows/
    release.yml
docs/
  index.css
  index.html
  index.js
faq/
  faq.css
  faq.html
  faq.js
.gitignore
background.js
CHANGELOG.md
content.js
manifest.json
popup.css
popup.html
popup.js
Privacy-Policy.md
README.md
utils.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="_locales/en/messages.json">
{
  "extName": {
    "message": "My Extension",
    "description": "The name of the extension."
  },
  "extDescription": {
    "message": "Makes your life better.",
    "description": "The description of the extension."
  }
}
</file>

<file path="docs/index.css">
:root {
  --primary: #0071dc;
  --danger: #e41e31;
  --success: #2ecc71;
  --background: #f8f9fa;
  --border: #e5e7eb;
  --text: #1a1a1a;
  --text-secondary: #666;
}
body {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color: var(--text);
  background: white;
  line-height: 1.6;
}
.header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.header h1 {
  font-size: 24px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
}
.faq-section {
  margin-bottom: 32px;
}
.faq-item {
  background: var(--background);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}
.faq-question {
  padding: 16px;
  font-weight: 500;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  user-select: none;
}
.faq-question:hover {
  background: rgba(0, 0, 0, 0.02);
}
.faq-answer {
  padding: 0 16px;
  font-size: 14px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}
.faq-answer.active {
  padding: 16px;
  max-height: 900px;
  border-top: 1px solid var(--border);
}
.faq-answer img {
  max-width: 100%;
  border: 1px solid var(--border);
  border-radius: 4px;
  margin: 8px 0;
}
.arrow {
  transition: transform 0.3s ease;
}
.arrow.active {
  transform: rotate(180deg);
}
.step {
  margin: 12px 0;
  padding-left: 24px;
  position: relative;
}
.note {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  color: #856404;
  padding: 12px;
  border-radius: 4px;
  margin: 12px 0;
}
/* Add to your existing CSS */
.copy-link-container {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #f5f5f5;
  padding: 8px;
  border-radius: 4px;
  margin: 8px 0;
}
.copy-link {
  flex: 1;
  user-select: all;
  font-family: monospace;
  font-size: 13px;
  overflow-x: auto;
  white-space: nowrap;
  padding: 4px;
}
.copy-button {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: color 0.2s;
}
.copy-button:hover {
  color: var(--primary);
}
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 12px 24px;
  border-radius: 4px;
  font-size: 14px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.show {
  opacity: 1;
  visibility: visible;
}
.toast svg {
  stroke: #4caf50;
}
/* Add these footer styles to the end of your existing faq.css file */
.footer {
  margin-top: 40px;
  padding-top: 20px;
  font-size: 16px;
  border-top: 1px solid var(--border);
  text-align: center;
}
.footer-container {
  max-width: 800px;
  margin: 0 auto;
}
.footer-title {
  font-size: 20px;
  margin-bottom: 15px;
  color: var(--text);
}
.footer-description {
  margin-bottom: 20px;
  color: var(--text-secondary);
}
.rating-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background-color: var(--primary);
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  margin-bottom: 20px;
  transition: background-color 0.2s ease;
}
.rating-button:hover {
  background-color: #005bb0;
}
.rating-button svg {
  stroke: white;
}
.footer-note {
  font-size: 16px;
  color: var(--text-secondary);
  margin-top: 20px;
}
.heart {
  color: #e41e31;
}
</file>

<file path="docs/index.html">
<!DOCTYPE html>
<html>
<head>
    <title>FAQ - Walmart Invoice Exporter</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./index.css">
</head>
<body>
    <div class="header"
        style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
        <svg style="width: 32px; height: 32px;" fill="#1a1a1a" version="1.1" id="Capa_1"
            xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 29.536 29.536"
            xml:space="preserve">
            <g>
                <path d="M14.768,0C6.611,0,0,6.609,0,14.768c0,8.155,6.611,14.767,14.768,14.767s14.768-6.612,14.768-14.767
                C29.535,6.609,22.924,0,14.768,0z M14.768,27.126c-6.828,0-12.361-5.532-12.361-12.359c0-6.828,5.533-12.362,12.361-12.362
                c6.826,0,12.359,5.535,12.359,12.362C27.127,21.594,21.594,27.126,14.768,27.126z" />
                <path d="M14.385,19.337c-1.338,0-2.289,0.951-2.289,2.34c0,1.336,0.926,2.339,2.289,2.339c1.414,0,2.314-1.003,2.314-2.339
                C16.672,20.288,15.771,19.337,14.385,19.337z" />
                <path
                    d="M14.742,6.092c-1.824,0-3.34,0.513-4.293,1.053l0.875,2.804c0.668-0.462,1.697-0.772,2.545-0.772
                c1.285,0.027,1.879,0.644,1.879,1.543c0,0.85-0.67,1.697-1.494,2.701c-1.156,1.364-1.594,2.701-1.516,4.012l0.025,0.669h3.42
                v-0.463c-0.025-1.158,0.387-2.162,1.311-3.215c0.979-1.08,2.211-2.366,2.211-4.321C19.705,7.968,18.139,6.092,14.742,6.092z" />
            </g>
        </svg>
        <h1 style="font-size: 32px; margin: 0; color: #1a1a1a; font-weight: 600;">Frequently Asked Questions</h1>
    </div>
    <div class="faq-section">
        <div class="faq-item">
            <div class="faq-question">
                How to Use the Extension
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p><strong>Single Order Download:</strong></p>
                <ol>
                    <li>Navigate to a specific Walmart order page</li>
                    <li>Click the extension icon</li>
                    <li>Click "Download Invoice"</li>
                </ol>
                <p style="margin-top: 20px;"><strong>Batch Download:</strong></p>
                <ol>
                    <li>Go to your Walmart order history page (walmart.com/orders)</li>
                    <li>Click the extension icon</li>
                    <li>Set the number of pages to crawl (0 = unlimited)</li>
                    <li>Click "Start Collection"</li>
                    <li>Wait for the order numbers to load</li>
                    <li>Select the orders you want to download</li>
                    <li>Click "Download Selected Orders"</li>
                    <li>Wait for the download to complete</li>
                </ol>
                <div class="note">
                    <strong>Note:</strong>
                    <ol style="margin: 5px 0 5px 20px;">
                        <li>Before downloading multiple orders, make sure you've configured the Chrome settings as
                            described in "Required Chrome Settings for Bulk Downloads" section below.</li>
                        <li>Batch download may take a few minutes depending on the number of orders selected.</li>
                        <li>Do not close the popup or change the window while using the extension. This will stop the
                            process and you'll have to restart from the beginning.</li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Required Chrome Settings for Bulk Downloads
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p style="margin-bottom: 15px;"><strong>1. Configure Download Settings:</strong></p>
                <ol>
                    <li>
                        Open Chrome settings by pasting the following link in a new tab: (click below to copy)
                        <div class="copy-link-container">
                            <code class="copy-link"
                                data-link="chrome://settings/downloads">chrome://settings/downloads</code>
                            <button class="copy-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>Click on "Downloads" in the left sidebar if not already selected</li>
                    <li>Turn OFF "Ask where to save each file before downloading"</li>
                    <li>Turn OFF "Show downloads when they're done"</li>
                </ol>
                <p style="margin: 20px 0 15px;"><strong>2. Enable Automatic Downloads:</strong></p>
                <ol>
                    <li>
                        Open Chrome settings by pasting the following link in a new tab: (click below to copy)
                        <div class="copy-link-container">
                            <code class="copy-link"
                                data-link="chrome://settings/content/siteDetails?site=https%3A%2F%2Fwww.walmart.com#:~:text=Automatic%20downloads">chrome://settings/content/siteDetails?site=https%3A%2F%2Fwww.walmart.com</code>
                            <button class="copy-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>Find "Automatic downloads" option</li>
                    <li>Set it to "Allow" (instead of Ask or Block)</li>
                </ol>
                <p style="margin: 20px 0 15px;"><strong>Alternative Method:</strong> (if above link doesn't work)</p>
                <ol>
                    <li>
                        Open Chrome settings by pasting the following link in a new tab: (click below to copy)
                        <div class="copy-link-container">
                            <code class="copy-link"
                                data-link="chrome://settings/content/automaticDownloads#:~:text=Allowed%20to%20automatically%20download%20multiple%20files">chrome://settings/content/automaticDownloads</code>
                            <button class="copy-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>Under "Allowed to automatically download multiple files", click Add</li>
                    <li>Enter "[*.]walmart.com" and click Add</li>
                </ol>
                <div class="note" style="margin-top: 20px;">
                    <strong>Important:</strong> All these settings are required for bulk downloads to work properly.
                    Make sure to add walmart.com under "Allowed to automatically download multiple files" and NOT under
                    "Not allowed to automatically download multiple files"
                </div>
                <div class="tip">
                    <strong>Note:</strong> Chrome doesn't allow direct clicking of these links. Please copy and paste
                    them manually into a new tab.
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Download Issues & Tips
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>Before downloading multiple orders, make sure you've configured the Chrome settings as described in
                    "Required Chrome Settings for Bulk Downloads" section above.</p>
                <div class="note" style="margin: 15px 0;">
                    <strong>Important:</strong> Do not close the popup or change the window while using the extension.
                    This will stop the process and you'll have to restart from the beginning.
                </div>
                <p style="margin-top: 15px;">If you're experiencing download issues, it could be due to:</p>
                <ul>
                    <li>Slow internet connection - try downloading fewer orders at once</li>
                    <li>Order age - very old orders might take longer to load</li>
                    <li>Browser resources - try closing other tabs and windows</li>
                </ul>
                <div class="tip">
                    <strong>Recommendation:</strong> For better reliability, try downloading 5-10 orders at a time
                    instead of selecting all orders at once.
                </div>
                <div class="note" style="margin-top: 15px;">
                    <strong>Important:</strong> Most download issues are solved by correctly configuring Chrome
                    settings. Please double-check the "Required Chrome Settings for Bulk Downloads" section if you're
                    having problems.
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                How to Merge Multiple Excel Files?
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>To merge multiple Excel files exported from this extension:</p>
                <ol>
                    <li>Visit <a href="https://hppanpaliya.github.io/excel-merger/" target="_blank"
                            style="color: var(--primary); text-decoration: none;">https://hppanpaliya.github.io/excel-merger/</a>
                    </li>
                    <li>Upload your exported Excel files</li>
                    <li>Download the merged file</li>
                </ol>
                <div class="tip">
                    <strong>Note:</strong> This tool is specifically designed to work with Excel files exported from
                    this extension.
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Need Help?
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>If you're still experiencing issues or have questions, feel free to reach out for support:</p>
                <div class="tip" style="text-align: center;">
                    <strong>Contact:</strong> <a href="mailto:harshal.hpp@gmail.com"
                        style="color: var(--primary); text-decoration: none;">harshal.hpp@gmail.com</a>
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Order Caching System
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>This extension now includes an intelligent caching system to improve performance:</p>
                <ul>
                    <li><strong>Automatic Caching:</strong> Order numbers are stored locally in your browser after
                        collection</li>
                    <li><strong>Faster Access:</strong> Previously collected orders appear instantly without needing to
                        recrawl pages</li>
                    <li><strong>Cache Management:</strong> A "Clear Cache" button lets you refresh data when needed</li>
                    <li><strong>Cache Expiration:</strong> Cached data automatically refreshes after 24 hours</li>
                </ul>
                <div class="note">
                    <strong>Benefits:</strong>
                    <ul style="margin: 5px 0 5px 20px;">
                        <li>Significantly faster repeat usage</li>
                        <li>Reduced server load and network requests</li>
                        <li>Works seamlessly with batch downloading</li>
                        <li>Cache timestamp shows when data was collected</li>
                    </ul>
                </div>
                <p style="margin-top: 15px;"><strong>How to use:</strong></p>
                <ul>
                    <li>When you open the extension, previously collected order numbers will appear automatically</li>
                    <li>You'll see a message indicating you're using cached data along with the cache date</li>
                    <li>To refresh the data, simply click the "Clear Cache" button and start collection again</li>
                </ul>
            </div>
        </div>
        <footer class="footer">
            <div class="footer-container">
                <h3 class="footer-title">Enjoying the Extension?</h3>
                <p class="footer-description">
                    If this tool has saved you time and made managing your Walmart orders easier,<br />please consider
                    leaving a review to share your experience!
                </p>
                <a href="https://chromewebstore.google.com/detail/walmart-invoice-exporter/bndkihecbbkoligeekekdgommmdllfpe/reviews"
                    target="_blank" class="rating-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon
                            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                        </polygon>
                    </svg>
                    Rate on Chrome Web Store
                </a>
                <p class="footer-note">
                    Your feedback motivates me to improve the extension and add new features!
                    <br>
                    <br>
                    Created with <span class="heart">❤️</span> by <a href="https://github.com/hppanpaliya"
                        target="_blank" style="color: var(--primary); text-decoration: none;">Harshal Panpaliya</a>
                </p>
            </div>
        </footer>
    </div>
    <script src="./index.js"></script>
</body>
</html>
</file>

<file path="docs/index.js">
// faq.js
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".faq-question").forEach((question) => {
    question.addEventListener("click", () => {
      const answer = question.nextElementSibling;
      const arrow = question.querySelector(".arrow");
      // Toggle current item
      answer.classList.toggle("active");
      arrow.classList.toggle("active");
      // Close other items
      document.querySelectorAll(".faq-answer").forEach((otherAnswer) => {
        if (otherAnswer !== answer && otherAnswer.classList.contains("active")) {
          otherAnswer.classList.remove("active");
          otherAnswer.previousElementSibling.querySelector(".arrow").classList.remove("active");
        }
      });
    });
  });
});
// Create toast element
const toastContainer = document.createElement("div");
toastContainer.className = "toast";
toastContainer.innerHTML = `
    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span>Link copied to clipboard!</span>
`;
document.body.appendChild(toastContainer);
// Handle copy functionality
document.querySelectorAll(".copy-button").forEach((button) => {
  button.addEventListener("click", async () => {
    const linkContainer = button.parentElement;
    const linkElement = linkContainer.querySelector(".copy-link");
    const linkText = linkElement.dataset.link;
    try {
      await navigator.clipboard.writeText(linkText);
      // Show toast
      toastContainer.classList.add("show");
      // Hide toast after 2 seconds
      setTimeout(() => {
        toastContainer.classList.remove("show");
      }, 3000);
      // Visual feedback on button
      button.style.color = "var(--success)";
      setTimeout(() => {
        button.style.color = "var(--text-secondary)";
      }, 1500);
    } catch (err) {
      console.error("Failed to copy text: ", err);
      toastContainer.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span>Failed to copy link</span>
            `;
      toastContainer.classList.add("show");
      setTimeout(() => {
        toastContainer.classList.remove("show");
      }, 3000);
    }
  });
});
// Also allow clicking the code element itself
document.querySelectorAll(".copy-link").forEach((link) => {
  link.addEventListener("click", async () => {
    const linkText = link.dataset.link;
    try {
      await navigator.clipboard.writeText(linkText);
      toastContainer.classList.add("show");
      setTimeout(() => {
        toastContainer.classList.remove("show");
      }, 3000);
    } catch (err) {
      console.error("Failed to copy text: ", err);
    }
  });
});
</file>

<file path="Privacy-Policy.md">
# Chrome Extensions Privacy Policy

_Effective Date: March 26, 2025_

I respect and value your privacy. This Privacy Policy describes how I handle and protect your personal information in relation to your use of my Google Chrome extension(s).

## Information Collection

My Google Chrome Extensions do not collect any personal information from users. I do not gather, store, or transmit any data that can be used to personally identify you, such as your name, email address, or location. Since no data is collected, none of your data is sold to third parties.

## Links to Other Websites

My Google Chrome Extensions may contain links to other websites not operated by me. This Privacy Policy does not cover how that website processes personal information. I encourage you to review the Privacy Policy of every website that you visit.

## Changes to this Privacy Policy

I reserve the right to amend this Privacy Policy at any time. Any changes will be effective immediately upon posting the revised Privacy Policy, and the "Effective Date" above will be updated. You are advised to review this Privacy Policy periodically for any changes.

By using my Google Chrome Extensions, you signify your consent and agreement to the terms of this Privacy Policy. If you do not agree with this Privacy Policy, please refrain from using my Google Chrome Extensions.

## Feedback

If you have questions or concerns about this Privacy Policy, you can contact me by [email](mailto:harshal.hpp@gmail.com).
</file>

<file path="faq/faq.js">
// faq.js
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".faq-question").forEach((question) => {
    question.addEventListener("click", () => {
      const answer = question.nextElementSibling;
      const arrow = question.querySelector(".arrow");
      // Toggle current item
      answer.classList.toggle("active");
      arrow.classList.toggle("active");
      // Close other items
      document.querySelectorAll(".faq-answer").forEach((otherAnswer) => {
        if (otherAnswer !== answer && otherAnswer.classList.contains("active")) {
          otherAnswer.classList.remove("active");
          otherAnswer.previousElementSibling.querySelector(".arrow").classList.remove("active");
        }
      });
    });
  });
});
// Create toast element
const toastContainer = document.createElement("div");
toastContainer.className = "toast";
toastContainer.innerHTML = `
    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span>Link copied to clipboard!</span>
`;
document.body.appendChild(toastContainer);
// Handle copy functionality
document.querySelectorAll(".copy-button").forEach((button) => {
  button.addEventListener("click", async () => {
    const linkContainer = button.parentElement;
    const linkElement = linkContainer.querySelector(".copy-link");
    const linkText = linkElement.dataset.link;
    try {
      await navigator.clipboard.writeText(linkText);
      // Show toast
      toastContainer.classList.add("show");
      // Hide toast after 2 seconds
      setTimeout(() => {
        toastContainer.classList.remove("show");
      }, 3000);
      // Visual feedback on button
      button.style.color = "var(--success)";
      setTimeout(() => {
        button.style.color = "var(--text-secondary)";
      }, 1500);
    } catch (err) {
      console.error("Failed to copy text: ", err);
      toastContainer.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span>Failed to copy link</span>
            `;
      toastContainer.classList.add("show");
      setTimeout(() => {
        toastContainer.classList.remove("show");
      }, 3000);
    }
  });
});
// Also allow clicking the code element itself
document.querySelectorAll(".copy-link").forEach((link) => {
  link.addEventListener("click", async () => {
    const linkText = link.dataset.link;
    try {
      await navigator.clipboard.writeText(linkText);
      toastContainer.classList.add("show");
      setTimeout(() => {
        toastContainer.classList.remove("show");
      }, 3000);
    } catch (err) {
      console.error("Failed to copy text: ", err);
    }
  });
});
</file>

<file path=".gitignore">
# macOS system files
.DS_Store

*/.DS_Store

# Chrome extension build files
/dist/
/node_modules/

# Chrome extension development files
*.log
*.swp
*.swo
*.bak
*.tmp
*.zip

# IDE and editor files
.idea/
.vscode/
*.sublime-project
*.sublime-workspace

# Dependency lock files
yarn.lock
package-lock.json

dev/

.aider*
.env
# Repomix (local dev only)
repomix.config.json
repomix-output.xml
</file>

<file path=".github/workflows/release.yml">
name: Create Branch Release
on:
  push:
    branches:
      - "*"  # Run on all branches
  workflow_dispatch: # Allow manual triggering
permissions:
  contents: write
jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get branch name
        id: branch
        run: echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_ENV
      - name: Get version from manifest.json
        id: version
        run: |
          VERSION=$(jq -r '.version' manifest.json)
          echo "version=$VERSION" >> $GITHUB_ENV
        shell: bash
      - name: Read CHANGELOG
        id: changelog
        run: |
          CHANGELOG=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - name: Create folder structure and ZIP file
        run: |
          mkdir -p temp/Walmart-Invoice-Exporter
          cp -r _locales temp/Walmart-Invoice-Exporter/
          cp -r images temp/Walmart-Invoice-Exporter/
          cp -r faq temp/Walmart-Invoice-Exporter/
          cp background.js temp/Walmart-Invoice-Exporter/
          cp content.js temp/Walmart-Invoice-Exporter/
          cp exceljs.bare.min.js temp/Walmart-Invoice-Exporter/
          cp manifest.json temp/Walmart-Invoice-Exporter/
          cp popup.html temp/Walmart-Invoice-Exporter/
          cp popup.js temp/Walmart-Invoice-Exporter/
          cp popup.css temp/Walmart-Invoice-Exporter/
          cp utils.js temp/Walmart-Invoice-Exporter/
          cd temp
          zip -r ../Walmart-Invoice-Exporter-${GITHUB_REF_NAME}-${version}.zip Walmart-Invoice-Exporter
          cd ..
          rm -rf temp
      # ---------------------------
      # Handle versioned release
      # ---------------------------
      - name: Delete existing versioned release
        uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          tag_name: v${{ env.version }}-${{ env.branch }}
          delete_release: true
          github_token: ${{ github.token }}
        continue-on-error: true 
      - name: Create versioned release
        uses: softprops/action-gh-release@v1
        with:
          files: Walmart-Invoice-Exporter-${{ env.branch }}-${{ env.version }}.zip
          tag_name: v${{ env.version }}-${{ env.branch }}
          name: Release v${{ env.version }} - ${{ env.branch }}
          body: ${{ env.changelog }}
          token: ${{ github.token }}
      # ---------------------------
      # Handle "latest" release for this branch
      # ---------------------------
      - name: Delete existing latest release for this branch
        uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          tag_name: latest-${{ env.branch }}
          delete_release: true
          github_token: ${{ github.token }}
        continue-on-error: true 
      - name: Create latest release for this branch
        uses: softprops/action-gh-release@v1
        with:
          files: Walmart-Invoice-Exporter-${{ env.branch }}-${{ env.version }}.zip
          tag_name: latest-${{ env.branch }}
          name: Latest Release - ${{ env.branch }}
          body: ${{ env.changelog }}
          token: ${{ github.token }}
</file>

<file path="faq/faq.css">
:root {
  --primary: #0071dc;
  --danger: #e41e31;
  --success: #2ecc71;
  --background: #f8f9fa;
  --border: #e5e7eb;
  --text: #1a1a1a;
  --text-secondary: #666;
}
body {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color: var(--text);
  background: white;
  line-height: 1.6;
}
.header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.header h1 {
  font-size: 24px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
}
.faq-section {
  margin-bottom: 32px;
}
.faq-item {
  background: var(--background);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}
.faq-question {
  padding: 16px;
  font-weight: 500;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  user-select: none;
}
.faq-question:hover {
  background: rgba(0, 0, 0, 0.02);
}
.faq-answer {
  padding: 0 16px;
  font-size: 14px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, padding 0.3s ease-out;
}
.faq-answer.active {
  padding: 16px;
  max-height: 900px;
  border-top: 1px solid var(--border);
}
.faq-answer img {
  max-width: 100%;
  border: 1px solid var(--border);
  border-radius: 4px;
  margin: 8px 0;
}
.arrow {
  transition: transform 0.3s ease;
}
.arrow.active {
  transform: rotate(180deg);
}
.step {
  margin: 12px 0;
  padding-left: 24px;
  position: relative;
}
.note {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  color: #856404;
  padding: 12px;
  border-radius: 4px;
  margin: 12px 0;
}
/* Add to your existing CSS */
.copy-link-container {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #f5f5f5;
  padding: 8px;
  border-radius: 4px;
  margin: 8px 0;
}
.copy-link {
  flex: 1;
  user-select: all;
  font-family: monospace;
  font-size: 13px;
  overflow-x: auto;
  white-space: nowrap;
  padding: 4px;
}
.copy-button {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: color 0.2s;
}
.copy-button:hover {
  color: var(--primary);
}
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 12px 24px;
  border-radius: 4px;
  font-size: 14px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.show {
  opacity: 1;
  visibility: visible;
}
.toast svg {
  stroke: #4caf50;
}
/* Add these footer styles to the end of your existing faq.css file */
.footer {
  margin-top: 40px;
  padding-top: 20px;
  font-size: 16px;
  border-top: 1px solid var(--border);
  text-align: center;
}
.footer-container {
  max-width: 800px;
  margin: 0 auto;
}
.footer-title {
  font-size: 20px;
  margin-bottom: 15px;
  color: var(--text);
}
.footer-description {
  margin-bottom: 20px;
  color: var(--text-secondary);
}
.rating-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background-color: var(--primary);
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  margin-bottom: 20px;
  transition: background-color 0.2s ease;
}
.rating-button:hover {
  background-color: #005bb0;
}
.rating-button svg {
  stroke: white;
}
.footer-note {
  font-size: 16px;
  color: var(--text-secondary);
  margin-top: 20px;
}
.heart {
  color: #e41e31;
}
</file>

<file path="faq/faq.html">
<!DOCTYPE html>
<html>
<head>
    <title>FAQ - Walmart Invoice Exporter</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./faq.css">
</head>
<body>
    <div class="header"
        style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
        <svg style="width: 32px; height: 32px;" fill="#1a1a1a" version="1.1" id="Capa_1"
            xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 29.536 29.536"
            xml:space="preserve">
            <g>
                <path d="M14.768,0C6.611,0,0,6.609,0,14.768c0,8.155,6.611,14.767,14.768,14.767s14.768-6.612,14.768-14.767
                C29.535,6.609,22.924,0,14.768,0z M14.768,27.126c-6.828,0-12.361-5.532-12.361-12.359c0-6.828,5.533-12.362,12.361-12.362
                c6.826,0,12.359,5.535,12.359,12.362C27.127,21.594,21.594,27.126,14.768,27.126z" />
                <path d="M14.385,19.337c-1.338,0-2.289,0.951-2.289,2.34c0,1.336,0.926,2.339,2.289,2.339c1.414,0,2.314-1.003,2.314-2.339
                C16.672,20.288,15.771,19.337,14.385,19.337z" />
                <path
                    d="M14.742,6.092c-1.824,0-3.34,0.513-4.293,1.053l0.875,2.804c0.668-0.462,1.697-0.772,2.545-0.772
                c1.285,0.027,1.879,0.644,1.879,1.543c0,0.85-0.67,1.697-1.494,2.701c-1.156,1.364-1.594,2.701-1.516,4.012l0.025,0.669h3.42
                v-0.463c-0.025-1.158,0.387-2.162,1.311-3.215c0.979-1.08,2.211-2.366,2.211-4.321C19.705,7.968,18.139,6.092,14.742,6.092z" />
            </g>
        </svg>
        <h1 style="font-size: 32px; margin: 0; color: #1a1a1a; font-weight: 600;">Frequently Asked Questions</h1>
    </div>
    <div class="faq-section">
        <div class="faq-item">
            <div class="faq-question">
                How to Use the Extension
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p><strong>Single Order Download:</strong></p>
                <ol>
                    <li>Navigate to a specific Walmart order page</li>
                    <li>Click the extension icon</li>
                    <li>Click "Download Invoice"</li>
                </ol>
                <p style="margin-top: 20px;"><strong>Batch Download:</strong></p>
                <ol>
                    <li>Go to your Walmart order history page (walmart.com/orders)</li>
                    <li>Click the extension icon</li>
                    <li>Set the number of pages to crawl (0 = unlimited)</li>
                    <li>Click "Start Collection"</li>
                    <li>Wait for the order numbers to load</li>
                    <li>Select the orders you want to download</li>
                    <li>Click "Download Selected Orders"</li>
                    <li>Wait for the download to complete</li>
                </ol>
                <div class="note">
                    <strong>Note:</strong>
                    <ol style="margin: 5px 0 5px 20px;">
                        <li>Before downloading multiple orders, make sure you've configured the Chrome settings as
                            described in "Required Chrome Settings for Bulk Downloads" section below.</li>
                        <li>Batch download may take a few minutes depending on the number of orders selected.</li>
                        <li>Do not close the popup or change the window while using the extension. This will stop the
                            process and you'll have to restart from the beginning.</li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Required Chrome Settings for Bulk Downloads
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p style="margin-bottom: 15px;"><strong>1. Configure Download Settings:</strong></p>
                <ol>
                    <li>
                        Open Chrome settings by pasting the following link in a new tab: (click below to copy)
                        <div class="copy-link-container">
                            <code class="copy-link"
                                data-link="chrome://settings/downloads">chrome://settings/downloads</code>
                            <button class="copy-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>Click on "Downloads" in the left sidebar if not already selected</li>
                    <li>Turn OFF "Ask where to save each file before downloading"</li>
                    <li>Turn OFF "Show downloads when they're done"</li>
                </ol>
                <p style="margin: 20px 0 15px;"><strong>2. Enable Automatic Downloads:</strong></p>
                <ol>
                    <li>
                        Open Chrome settings by pasting the following link in a new tab: (click below to copy)
                        <div class="copy-link-container">
                            <code class="copy-link"
                                data-link="chrome://settings/content/siteDetails?site=https%3A%2F%2Fwww.walmart.com#:~:text=Automatic%20downloads">chrome://settings/content/siteDetails?site=https%3A%2F%2Fwww.walmart.com</code>
                            <button class="copy-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>Find "Automatic downloads" option</li>
                    <li>Set it to "Allow" (instead of Ask or Block)</li>
                </ol>
                <p style="margin: 20px 0 15px;"><strong>Alternative Method:</strong> (if above link doesn't work)</p>
                <ol>
                    <li>
                        Open Chrome settings by pasting the following link in a new tab: (click below to copy)
                        <div class="copy-link-container">
                            <code class="copy-link"
                                data-link="chrome://settings/content/automaticDownloads#:~:text=Allowed%20to%20automatically%20download%20multiple%20files">chrome://settings/content/automaticDownloads</code>
                            <button class="copy-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>Under "Allowed to automatically download multiple files", click Add</li>
                    <li>Enter "[*.]walmart.com" and click Add</li>
                </ol>
                <div class="note" style="margin-top: 20px;">
                    <strong>Important:</strong> All these settings are required for bulk downloads to work properly.
                    Make sure to add walmart.com under "Allowed to automatically download multiple files" and NOT under
                    "Not allowed to automatically download multiple files"
                </div>
                <div class="tip">
                    <strong>Note:</strong> Chrome doesn't allow direct clicking of these links. Please copy and paste
                    them manually into a new tab.
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Download Issues & Tips
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>Before downloading multiple orders, make sure you've configured the Chrome settings as described in
                    "Required Chrome Settings for Bulk Downloads" section above.</p>
                <div class="note" style="margin: 15px 0;">
                    <strong>Important:</strong> Do not close the popup or change the window while using the extension.
                    This will stop the process and you'll have to restart from the beginning.
                </div>
                <p style="margin-top: 15px;">If you're experiencing download issues, it could be due to:</p>
                <ul>
                    <li>Slow internet connection - try downloading fewer orders at once</li>
                    <li>Order age - very old orders might take longer to load</li>
                    <li>Browser resources - try closing other tabs and windows</li>
                </ul>
                <div class="tip">
                    <strong>Recommendation:</strong> For better reliability, try downloading 5-10 orders at a time
                    instead of selecting all orders at once.
                </div>
                <div class="note" style="margin-top: 15px;">
                    <strong>Important:</strong> Most download issues are solved by correctly configuring Chrome
                    settings. Please double-check the "Required Chrome Settings for Bulk Downloads" section if you're
                    having problems.
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                How to Merge Multiple Excel Files?
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>To merge multiple Excel files exported from this extension:</p>
                <ol>
                    <li>Visit <a href="https://hppanpaliya.github.io/excel-merger/" target="_blank"
                            style="color: var(--primary); text-decoration: none;">https://hppanpaliya.github.io/excel-merger/</a>
                    </li>
                    <li>Upload your exported Excel files</li>
                    <li>Download the merged file</li>
                </ol>
                <div class="tip">
                    <strong>Note:</strong> This tool is specifically designed to work with Excel files exported from
                    this extension.
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Need Help?
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>If you're still experiencing issues or have questions, feel free to reach out for support:</p>
                <div class="tip" style="text-align: center;">
                    <strong>Contact:</strong> <a href="mailto:harshal.hpp@gmail.com"
                        style="color: var(--primary); text-decoration: none;">harshal.hpp@gmail.com</a>
                </div>
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question">
                Order Caching System
                <svg class="arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="faq-answer">
                <p>This extension now includes an intelligent caching system to improve performance:</p>
                <ul>
                    <li><strong>Automatic Caching:</strong> Order numbers are stored locally in your browser after
                        collection</li>
                    <li><strong>Faster Access:</strong> Previously collected orders appear instantly without needing to
                        recrawl pages</li>
                    <li><strong>Cache Management:</strong> A "Clear Cache" button lets you refresh data when needed</li>
                    <li><strong>Cache Expiration:</strong> Cached data automatically refreshes after 24 hours</li>
                </ul>
                <div class="note">
                    <strong>Benefits:</strong>
                    <ul style="margin: 5px 0 5px 20px;">
                        <li>Significantly faster repeat usage</li>
                        <li>Reduced server load and network requests</li>
                        <li>Works seamlessly with batch downloading</li>
                        <li>Cache timestamp shows when data was collected</li>
                    </ul>
                </div>
                <p style="margin-top: 15px;"><strong>How to use:</strong></p>
                <ul>
                    <li>When you open the extension, previously collected order numbers will appear automatically</li>
                    <li>You'll see a message indicating you're using cached data along with the cache date</li>
                    <li>To refresh the data, simply click the "Clear Cache" button and start collection again</li>
                </ul>
            </div>
        </div>
        <footer class="footer">
            <div class="footer-container">
                <h3 class="footer-title">Enjoying the Extension?</h3>
                <p class="footer-description">
                    If this tool has saved you time and made managing your Walmart orders easier,<br />please consider
                    leaving a review to share your experience!
                </p>
                <a href="https://chromewebstore.google.com/detail/walmart-invoice-exporter/bndkihecbbkoligeekekdgommmdllfpe/reviews"
                    target="_blank" class="rating-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon
                            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                        </polygon>
                    </svg>
                    Rate on Chrome Web Store
                </a>
                <p class="footer-note">
                    Your feedback motivates me to improve the extension and add new features!
                    <br>
                    <br>
                    Created with <span class="heart">❤️</span> by <a href="https://github.com/hppanpaliya"
                        target="_blank" style="color: var(--primary); text-decoration: none;">Harshal Panpaliya</a>
                </p>
            </div>
        </footer>
    </div>
    <script src="./faq.js"></script>
</body>
</html>
</file>

<file path="utils.js">
/**
 * Shared utility functions for Excel export functionality
 * Used by both content.js and popup.js
 */
// Define font styles as constants
const STYLES = {
  headerFont: { size: 12, bold: true, name: "Times New Roman" },
  productFont: { size: 12, name: "Times New Roman" },
  boldFont: { size: 12, bold: true, name: "Times New Roman" },
  linkFont: { color: { argb: "FF0000FF" }, underline: true },
};
/**
 * Parse a numeric value from a string, removing currency symbols and formatting
 * @param {string} value - The value to parse (e.g., "$123.45", "100")
 * @returns {number} The parsed number value
 */
function parseNumericValue(value) {
  if (typeof value === 'number') return value;
  return Number(String(value || '').replace(/[^0-9.-]+/g, '')) || 0;
}
/**
 * Configure columns for a single order export worksheet
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to configure
 */
function configureSingleOrderColumns(worksheet) {
  worksheet.columns = [
    { header: "Product Name", key: "productName", width: 60 },
    { header: "Quantity", key: "quantity", width: 20, style: { numFmt: "#,##0", alignment: { horizontal: "center" } } },
    { header: "Price", key: "price", width: 20, style: { numFmt: "$#,##0.00", alignment: { horizontal: "center" } } },
    { header: "Delivery Status", key: "deliveryStatus", width: 30, style: { alignment: { horizontal: "center" } } },
    { header: "Product Link", key: "productLink", width: 60, style: { font: STYLES.linkFont } },
  ];
}
/**
 * Configure columns for a combined multiple orders export worksheet
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to configure
 */
function configureMultipleOrdersColumns(worksheet) {
  worksheet.columns = [
    { header: 'Order Number', key: 'orderNumber', width: 20, style: { alignment: { horizontal: "center" } } },
    { header: 'Order Date', key: 'orderDate', width: 20, style: { alignment: { horizontal: "center" } } },
    { header: 'Product Name', key: 'productName', width: 60, style: { alignment: { horizontal: "center" } } },
    { header: 'Quantity', key: 'quantity', width: 10, style: { numFmt: "#,##0", alignment: { horizontal: "center" } } },
    { header: 'Price', key: 'price', width: 10, style: { numFmt: "$#,##0.00", alignment: { horizontal: "center" } } },
    { header: 'Delivery Status', key: 'deliveryStatus', width: 20, style: { alignment: { horizontal: "center" } } },
    { header: 'Product Link', key: 'productLink', width: 60 , style: { font: STYLES.linkFont } },
  ];
}
/**
 * Add items from a single order to a worksheet
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to add items to
 * @param {Array} items - The items to add
 */
function addItemsToWorksheet(worksheet, items) {
  items.forEach((item) => {
    const row = worksheet.addRow({
      productName: item.productName,
      productLink: {
        text: truncateText(item.productName),
        hyperlink: item.productLink
      },
      quantity: parseNumericValue(item.quantity),
      price: parseNumericValue(item.price),
      deliveryStatus: item.deliveryStatus,
    });
    row.font = STYLES.productFont;
  });
}
/**
 * Add items from multiple orders to a worksheet
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to add items to
 * @param {Array} items - The items to add (with orderNumber and orderDate)
 */
function addMultipleOrderItemsToWorksheet(worksheet, items) {
  items.forEach((item) => {
    worksheet.addRow({
      orderNumber: item.orderNumber || '',
      orderDate: item.orderDate || '',
      productName: item.productName || '',
      quantity: parseNumericValue(item.quantity),
      price: parseNumericValue(item.price),
      deliveryStatus: item.deliveryStatus || '',
      productLink: {
        text: truncateText(item.productName),
        hyperlink: item.productLink
      },
    });
  });
}
/**
 * Apply styling to worksheet for single order export
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to style
 */
function styleSingleOrderWorksheet(worksheet) {
  // Apply product font to all cells
  worksheet.eachRow((row) => {
    row.eachCell((cell) => {
      cell.font = STYLES.productFont;
    });
    const cell = row.getCell("productLink");
    if (cell) {
      cell.font = STYLES.linkFont;
    }
  });
  // Apply header font to first row
  worksheet.getRow(1).eachCell((cell) => {
    cell.font = STYLES.headerFont;
  });
}
/**
 * Apply styling to worksheet for multiple orders export
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to style
 */
function styleMultipleOrdersWorksheet(worksheet) {
  worksheet.getRow(1).font = { bold: true };
}
/**
 * Add order summary details to a worksheet (for single order export)
 * @param {ExcelJS.Worksheet} worksheet - The worksheet to add details to
 * @param {Object} orderDetails - The order details object
 */
function addOrderSummary(worksheet, orderDetails) {
  // Add empty row for spacing
  worksheet.addRow([]);
  // Add order details
  const rows = [
    ['Order Number', orderDetails.orderNumber],
    ['Order Date', orderDetails.orderDate],
    ['Delivery Charges', parseNumericValue(orderDetails.deliveryCharges)],
    ['Tax', parseNumericValue(orderDetails.tax)],
    ['Tip', parseNumericValue(orderDetails.tip)],
    ['Order Total', parseNumericValue(orderDetails.orderTotal)],
  ];
  const summaryRows = rows.map(([label, value]) => {
    const row = worksheet.addRow([label, value]);
    row.font = { ...STYLES.productFont, bold: true };
    return row;
  });
  // Apply currency formatting to numeric values
  summaryRows.slice(2).forEach((row) => {
    row.getCell(2).numFmt = "$#,##0.00";
    row.getCell(2).font = { ...STYLES.productFont, bold: true };
    row.getCell(1).font = { ...STYLES.productFont, bold: true };
    row.getCell(2).alignment = { horizontal: "center" };
  });
}
/**
 * Trigger download of a workbook as an Excel file
 * @param {ExcelJS.Workbook} workbook - The workbook to download
 * @param {string} filename - The filename for the download
 */
async function downloadWorkbook(workbook, filename) {
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
  const url = window.URL.createObjectURL(blob);
  const anchor = document.createElement("a");
  anchor.href = url;
  anchor.download = filename;
  document.body.appendChild(anchor);
  anchor.click();
  document.body.removeChild(anchor);
  window.URL.revokeObjectURL(url);
}
/**
 * Convert order data to Excel format and download
 * Flexible function that handles both single order and multiple order exports
 * 
 * @param {Object} orderDetails - The order data (for single) or array of orders (for multiple)
 * @param {Object} ExcelJS - The ExcelJS library
 * @param {Object} options - Configuration options
 * @param {string} options.mode - Export mode: 'single' (one order with summary) or 'multiple' (all items combined)
 * @param {string} options.filename - Optional custom filename
 */
async function convertToXlsx(orderDetails, ExcelJS, options = {}) {
  const { mode = 'single', filename = null } = options;
  if (mode === 'single') {
    // Single order export with full details
    return convertSingleOrderToXlsx(orderDetails, ExcelJS, filename);
  } else if (mode === 'multiple') {
    // Multiple orders combined into one sheet
    return convertMultipleOrdersToXlsx(orderDetails, ExcelJS, filename);
  }
}
/**
 * Convert a single order to XLSX format with full details including summary
 * @param {Object} orderDetails - The order details object
 * @param {Object} ExcelJS - The ExcelJS library
 * @param {string} filename - Optional custom filename
 */
async function convertSingleOrderToXlsx(orderDetails, ExcelJS, filename = null) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("Order Invoice");
  // Configure columns for single order
  configureSingleOrderColumns(worksheet);
  // Add items
  addItemsToWorksheet(worksheet, orderDetails.items || []);
  // Add order summary
  addOrderSummary(worksheet, orderDetails);
  // Apply styling
  styleSingleOrderWorksheet(worksheet);
  // Download
  const downloadFilename = filename || `Order_${orderDetails.orderNumber}.xlsx`;
  await downloadWorkbook(workbook, downloadFilename);
}
/**
 * Convert multiple orders data to a single XLSX file with all items combined
 * @param {Array} ordersData - Array of order data objects, each containing items with order details
 * @param {Object} ExcelJS - The ExcelJS library
 * @param {string} filename - Optional custom filename
 */
async function convertMultipleOrdersToXlsx(ordersData, ExcelJS, filename = null) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Walmart Orders');
  // Configure columns for multiple orders
  configureMultipleOrdersColumns(worksheet);
  // Flatten all items from all orders into a single list with order info
  const allItems = [];
  const ordersArray = Array.isArray(ordersData) ? ordersData : [ordersData];
  ordersArray.forEach((orderDetails) => {
    (orderDetails.items || []).forEach((item) => {
      allItems.push({
        orderNumber: orderDetails.orderNumber || '',
        orderDate: orderDetails.orderDate || '',
        productName: item.productName || '',
        quantity: item.quantity,
        price: item.price,
        deliveryStatus: item.deliveryStatus || '',
        productLink: item.productLink || '',
      });
    });
  });
  // Add all items to worksheet
  addMultipleOrderItemsToWorksheet(worksheet, allItems);
  // Apply styling
  styleMultipleOrdersWorksheet(worksheet);
  // Download
  const downloadFilename = filename || 'Walmart_Orders.xlsx';
  await downloadWorkbook(workbook, downloadFilename);
}
/**
 * SVG Icon constants - Centralized icon definitions used throughout the extension
 */
const SVG_ICONS = {
  ERROR_CIRCLE: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
  SUCCESS_CHECKMARK: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
  TRASH: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></svg>',
  PACKAGE: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
  INFO_CIRCLE: '<svg width="12" height="12" viewBox="0 0 50 50" fill="none" stroke="currentColor" stroke-width="2"><path d="M 25 2 C 12.309295 2 2 12.309295 2 25 C 2 37.690705 12.309295 48 25 48 C 37.690705 48 48 37.690705 48 25 C 48 12.309295 37.690705 2 25 2 z M 25 4 C 36.609824 4 46 13.390176 46 25 C 46 36.609824 36.609824 46 25 46 C 13.390176 46 4 36.609824 4 25 C 4 13.390176 13.390176 4 25 4 z M 25 11 A 3 3 0 0 0 22 14 A 3 3 0 0 0 25 17 A 3 3 0 0 0 28 14 A 3 3 0 0 0 25 11 z M 21 21 L 21 23 L 22 23 L 23 23 L 23 36 L 22 36 L 21 36 L 21 38 L 22 38 L 23 38 L 27 38 L 28 38 L 29 38 L 29 36 L 28 36 L 27 36 L 27 21 L 26 21 L 22 21 L 21 21 z"></path></svg>',
  DOWNLOAD: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
  ERROR_LARGE: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e41e31" stroke-width="2" style="margin-bottom: 16px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
  STAR: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
  X_CLOSE: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
  CACHE: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3c4.97 0 9 3.582 9 8s-4.03 8-9 8-9-3.582-9-8 4.03-8 9-8m0-2C6.477 1 2 4.925 2 9.72c0 3.45 2.563 6.43 6 7.723V22h8v-4.558c3.437-1.294 6-4.273 6-7.723 0-4.795-4.477-8.72-10-8.72z"></path></svg>',
};
/**
 * Render an SVG icon with optional styling
 * @param {string} iconKey - Key from SVG_ICONS object
 * @param {string} color - Optional color variable (e.g., 'var(--success)', 'var(--danger)')
 * @returns {string} HTML string of the icon
 */
function renderIcon(iconKey, color = null) {
  let svg = SVG_ICONS[iconKey] || '';
  if (color && svg) {
    svg = svg.replace('stroke="currentColor"', `stroke="${color}"`);
  }
  return svg;
}
/**
 * UI Message Templates - Centralized message factory functions
 */
/**
 * Create a progress message with spinner and text
 * @param {number} current - Current item number
 * @param {number} total - Total items
 * @param {string} action - Action being performed (e.g., "Collecting data", "Downloading order")
 * @param {string} identifier - Item identifier (e.g., order number)
 * @param {string} spinnerColor - CSS color for spinner (default: var(--success))
 * @returns {string} HTML string
 */
function createProgressMessage(current, total, action, identifier, spinnerColor = 'var(--success)') {
  return `
    <span class="loading-spinner" style="border-color: ${spinnerColor}; border-top-color: transparent;"></span>
    ${action} ${current} of ${total} (#${identifier})...
  `;
}
/**
 * Create a success completion message
 * @param {string} message - Success message text
 * @returns {string} HTML string with success icon
 */
function createSuccessMessage(message) {
  return `
    ${renderIcon('SUCCESS_CHECKMARK', 'var(--success)')}
    ${message}
  `.replace('stroke="currentColor"', 'stroke="var(--success)"');
}
/**
 * Create an error completion message
 * @param {string} message - Error message text
 * @returns {string} HTML string with error icon
 */
function createErrorMessage(message) {
  return `
    ${renderIcon('ERROR_CIRCLE', 'var(--danger)')}
    ${message}
  `.replace('stroke="currentColor"', 'stroke="var(--danger)"');
}
/**
 * Constants for CSS classes, selectors, and text strings
 */
const CONSTANTS = {
  // CSS Classes
  CSS_CLASSES: {
    BTN_SUCCESS: 'btn btn-success',
    BTN_PRIMARY: 'btn btn-primary',
    BTN_DANGER: 'btn btn-danger',
    BTN_CLEAR: 'btn btn-clear',
    CHECKBOX_CONTAINER: 'checkbox-container',
    ORDER_LABEL: 'order-label',
    INFO_ICON: 'info-icon',
    ORDER_TOOLTIP: 'order-tooltip',
    LOADING_SPINNER: 'loading-spinner',
  },
  // DOM Selectors (content.js)
  SELECTORS: {
    PRINT_ITEMS: '.dn.print-items-list',
    PRINT_ITEM_NAME: '.w_U9_0.w_sD6D.w_QcqU',
    PRINT_BILL_TYPE: '.print-bill-type .w_U9_0.w_sD6D.w_QcqU',
    PRINT_BILL_QTY: '.print-bill-qty .w_U9_0.w_sD6D.w_QcqU',
    PRINT_BILL_PRICE: '.print-bill-price .w_U9_0.w_sD6D.w_QcqU',
    VISIBLE_ITEMS: '[data-testid="itemtile-stack"] [data-testid="productName"] span',
    ITEM_STACK: '[data-testid="itemtile-stack"]',
    PRODUCT_LINK: 'a[link-identifier="itemClick"]',
    ORDER_NUMBER_BAR: '.f-subheadline-m.dark-gray-m.print-bill-bar-id',
    ORDER_INFO_CARD: "[data-testid='orderInfoCard'] .dark-gray",
    ORDER_NUMBER_HEADING: '.print-bill-heading .dark-gray',
    PRINT_BILL_ID: '.print-bill-bar-id',
    ORDER_DATE: '.print-bill-date',
    ORDER_TOTAL: '.bill-order-total-payment h2:last-child',
    DELIVERY_CHARGES: '.print-fees',
    TAX_ELEMENTS: '.w_iUH7',
    TIP: '.print-bill-payment-section .flex.justify-between.pb2.pt3 .w_U9_0.w_U0S3.w_QcqU:last-child',
    ORDER_CARDS: '[data-testid^="order-"]',
    NEXT_BUTTON: 'button[data-automation-id="next-pages-button"]:not([disabled])',
    MAIN_HEADING: 'h1.w_kV33.w_LD4J.w_mvVb',
  },
  // Text Strings
  TEXT: {
    ORDER_PREFIX: 'Order #',
    SELECT_ALL: 'Select All',
    DOWNLOADING: 'Downloading order',
    COLLECTING: 'Collecting data',
    EXPORT_SUCCESS: 'Export completed successfully!',
    RETRY_PREFIX: 'Retrying order',
    DELIVERY_LABEL: 'Delivered',
    CART_ICON_TITLE: 'Walmart Invoice Exporter',
    SELECT_ORDERS: 'Select orders to download',
    CLEAR_CACHE_BTN: 'Clear Cache',
    USING_CACHE: 'Using cached data:',
    ORDERS: 'orders from',
    PAGES: 'pages',
  },
  // Chrome Messages
  MESSAGES: {
    START_COLLECTION: 'startCollection',
    STOP_COLLECTION: 'stopCollection',
    GET_PROGRESS: 'getProgress',
    CLEAR_CACHE: 'clearCache',
    COLLECT_ORDER_NUMBERS: 'collectOrderNumbers',
    CLICK_NEXT_BUTTON: 'clickNextButton',
    BLOCK_IMAGES: 'blockImagesForDownload',
    DOWNLOAD_XLSX: 'downloadXLSX',
    GET_ORDER_DATA: 'getOrderData',
  },
  // URL Parameters
  URLS: {
    WALMART_ORDERS: 'https://www.walmart.com/orders',
    WALMART_REVIEWS: 'https://chromewebstore.google.com/detail/walmart-invoice-exporter/bndkihecbbkoligeekekdgommmdllfpe/reviews',
  },
  // Timing Constants (in milliseconds)
  TIMING: {
    IMAGE_BLOCK_DELAY: 500,
    PAGE_LOAD_WAIT: 800,
    DOWNLOAD_TIMEOUT: 30000,
    COLLECTION_TIMEOUT: 30000,
    RETRY_DELAY: 400,
    RATING_DELAY: 500,
    HINT_DISMISS_DELAY: 5000,
    CACHE_EXPIRATION: 24 * 60 * 60 * 1000, // 24 hours
  },
  // Order Number Regex
  ORDER_NUMBER_REGEX: /#\s*([\d-]+)/,
  // Export Modes
  EXPORT_MODES: {
    SINGLE: 'single',
    MULTIPLE: 'multiple',
  },
};
/**
 * DOM Factory Functions - Reusable DOM element creation
 */
/**
 * Create a checkbox element with label and optional tooltip
 * @param {Object} config - Configuration object
 * @param {string} config.id - Checkbox ID
 * @param {string} config.value - Checkbox value
 * @param {string} config.label - Label text
 * @param {string} config.tooltip - Optional tooltip text
 * @param {string} config.className - Optional additional CSS class
 * @returns {HTMLElement} Div containing checkbox and label
 */
function createCheckboxElement(config) {
  const { id, value, label, tooltip = null, className = CONSTANTS.CSS_CLASSES.CHECKBOX_CONTAINER } = config;
  const div = document.createElement('div');
  div.className = className;
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = id;
  checkbox.value = value;
  const labelEl = document.createElement('label');
  labelEl.htmlFor = id;
  labelEl.className = CONSTANTS.CSS_CLASSES.ORDER_LABEL;
  const labelText = document.createElement('span');
  labelText.textContent = label;
  labelEl.appendChild(labelText);
  // Add tooltip if provided
  if (tooltip) {
    const infoIcon = document.createElement('span');
    infoIcon.className = CONSTANTS.CSS_CLASSES.INFO_ICON;
    infoIcon.innerHTML = renderIcon('INFO_CIRCLE');
    labelEl.appendChild(infoIcon);
    const tooltipEl = document.createElement('span');
    tooltipEl.className = CONSTANTS.CSS_CLASSES.ORDER_TOOLTIP;
    tooltipEl.textContent = tooltip;
    labelEl.appendChild(tooltipEl);
  }
  div.appendChild(checkbox);
  div.appendChild(labelEl);
  return div;
}
/**
 * Create a button element
 * @param {Object} config - Configuration object
 * @param {string} config.id - Button ID
 * @param {string} config.className - CSS classes
 * @param {string} config.innerHTML - Inner HTML content
 * @param {Function} config.onClick - Optional click handler
 * @returns {HTMLElement} Button element
 */
function createButtonElement(config) {
  const { id, className, innerHTML, onClick = null } = config;
  const button = document.createElement('button');
  if (id) button.id = id;
  button.className = className;
  button.innerHTML = innerHTML;
  if (onClick) {
    button.addEventListener('click', onClick);
  }
  return button;
}
/**
 * Create a div element with optional styling
 * @param {Object} config - Configuration object
 * @param {string} config.id - Div ID
 * @param {string} config.className - CSS classes
 * @param {string} config.innerHTML - Inner HTML content
 * @param {Object} config.style - Optional inline styles object
 * @returns {HTMLElement} Div element
 */
function createDivElement(config) {
  const { id = null, className = '', innerHTML = '', style = {} } = config;
  const div = document.createElement('div');
  if (id) div.id = id;
  if (className) div.className = className;
  if (innerHTML) div.innerHTML = innerHTML;
  Object.assign(div.style, style);
  return div;
}
/**
 * Checkbox & Selection Utilities - Repeated DOM query patterns
 */
/**
 * Get all selected order numbers from checkboxes
 * @returns {Array<string>} Array of selected order numbers
 */
function getSelectedOrderNumbers() {
  return Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
    .map((cb) => cb.value)
    .filter((value) => value !== 'on');
}
/**
 * Set disabled state for all order checkboxes
 * @param {boolean} disabled - True to disable, false to enable
 */
function setCheckboxesDisabled(disabled) {
  document.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
    cb.disabled = disabled;
  });
}
/**
 * Toggle all checkboxes in a container
 * @param {HTMLElement} container - Container with checkboxes
 * @param {boolean} checked - True to check all, false to uncheck
 */
function toggleAllCheckboxes(container, checked) {
  container.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
    cb.checked = checked;
  });
}
/**
 * Element Visibility & Display Utilities
 */
/**
 * Set display property for multiple elements
 * @param {Array<string|HTMLElement>} elements - Elements (IDs or DOM elements)
 * @param {string} display - Display value ('block', 'none', 'inline-flex', etc.)
 */
function setElementsDisplay(elements, display) {
  elements.forEach((el) => {
    let element = el;
    if (typeof el === 'string') {
      element = document.getElementById(el);
    }
    if (element) {
      element.style.display = display;
    }
  });
}
/**
 * Show elements
 * @param {Array<string|HTMLElement>} elements - Elements to show
 */
function showElements(elements) {
  setElementsDisplay(elements, 'block');
}
/**
 * Hide elements
 * @param {Array<string|HTMLElement>} elements - Elements to hide
 */
function hideElements(elements) {
  setElementsDisplay(elements, 'none');
}
/**
 * Promise & Async Utilities
 */
/**
 * Create a promise that resolves after a delay
 * @param {number} ms - Delay in milliseconds
 * @returns {Promise}
 */
function delay(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}
/**
 * Wrap a promise with a timeout
 * @param {Promise} promise - Promise to wrap
 * @param {number} timeoutMs - Timeout in milliseconds
 * @param {string} errorMessage - Error message if timeout occurs
 * @returns {Promise}
 */
function promiseWithTimeout(promise, timeoutMs, errorMessage) {
  return Promise.race([
    promise,
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
    ),
  ]);
}
/**
 * Text Processing Utilities
 */
/**
 * Truncate text to a maximum length
 * @param {string} text - Text to truncate
 * @param {number} maxLength - Maximum length (default: 60)
 * @param {string} suffix - Suffix for truncated text (default: "...")
 * @returns {string} Truncated text
 */
function truncateText(text, maxLength = 60, suffix = '...') {
  if (!text || text.length <= maxLength) return text;
  return text.substring(0, maxLength) + suffix;
}
/**
 * Invoice Caching Utilities
 */
const INVOICE_CACHE_KEY = 'walmart_invoice_cache';
const INVOICE_CACHE_EXPIRATION = 24 * 60 * 60 * 1000; // 24 hours
/**
 * Get cached invoice data for an order
 * @param {string} orderNumber - The order number
 * @returns {Promise<Object|null>} Cached invoice data or null if not cached or expired
 */
function getCachedInvoice(orderNumber) {
  return new Promise((resolve) => {
    chrome.storage.local.get([INVOICE_CACHE_KEY], (result) => {
      if (!result[INVOICE_CACHE_KEY]) {
        resolve(null);
        return;
      }
      const cache = result[INVOICE_CACHE_KEY];
      const cached = cache[orderNumber];
      if (!cached) {
        resolve(null);
        return;
      }
      // Check if cache is expired
      if (Date.now() - cached.timestamp > INVOICE_CACHE_EXPIRATION) {
        // Remove expired cache
        deleteInvoiceCache(orderNumber);
        resolve(null);
        return;
      }
      resolve(cached.data);
    });
  });
}
/**
 * Save invoice data to cache
 * @param {string} orderNumber - The order number
 * @param {Object} invoiceData - The invoice data to cache
 * @returns {Promise<void>}
 */
function cacheInvoice(orderNumber, invoiceData) {
  return new Promise((resolve) => {
    chrome.storage.local.get([INVOICE_CACHE_KEY], (result) => {
      const cache = result[INVOICE_CACHE_KEY] || {};
      cache[orderNumber] = {
        data: invoiceData,
        timestamp: Date.now(),
      };
      chrome.storage.local.set({ [INVOICE_CACHE_KEY]: cache }, () => {
        console.log(`Cached invoice data for order ${orderNumber}`);
        resolve();
      });
    });
  });
}
/**
 * Delete cached invoice for a specific order
 * @param {string} orderNumber - The order number
 * @returns {Promise<void>}
 */
function deleteInvoiceCache(orderNumber) {
  return new Promise((resolve) => {
    chrome.storage.local.get([INVOICE_CACHE_KEY], (result) => {
      const cache = result[INVOICE_CACHE_KEY] || {};
      delete cache[orderNumber];
      if (Object.keys(cache).length === 0) {
        chrome.storage.local.remove(INVOICE_CACHE_KEY, resolve);
      } else {
        chrome.storage.local.set({ [INVOICE_CACHE_KEY]: cache }, () => {
          console.log(`Deleted cache for order ${orderNumber}`);
          resolve();
        });
      }
    });
  });
}
/**
 * Get all cached order numbers
 * @returns {Promise<Array>} Array of cached order numbers
 */
function getCachedOrderNumbers() {
  return new Promise((resolve) => {
    chrome.storage.local.get([INVOICE_CACHE_KEY], (result) => {
      if (!result[INVOICE_CACHE_KEY]) {
        resolve([]);
        return;
      }
      const orderNumbers = Object.keys(result[INVOICE_CACHE_KEY]);
      // Filter out expired ones
      const validOrders = [];
      for (const order of orderNumbers) {
        const cached = result[INVOICE_CACHE_KEY][order];
        if (Date.now() - cached.timestamp <= INVOICE_CACHE_EXPIRATION) {
          validOrders.push(order);
        }
      }
      resolve(validOrders);
    });
  });
}
/**
 * Clear all invoice cache
 * @returns {Promise<void>}
 */
function clearAllInvoiceCache() {
  return new Promise((resolve) => {
    chrome.storage.local.remove(INVOICE_CACHE_KEY, () => {
      console.log('All invoice cache cleared');
      resolve();
    });
  });
}
</file>

<file path="popup.css">
:root {
  --primary: #0071dc;
  --danger: #e41e31;
  --success: #2ecc71;
  --background: #f8f9fa;
  --border: #e5e7eb;
  --text: #1a1a1a;
  --text-secondary: #666;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  width: 400px;
  padding: 10px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color: var(--text);
  background: white;
}
.header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
.header h1 {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
}
.card {
  background: var(--background);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}
.input-group {
  margin-bottom: 16px;
}
.input-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 12px;
  color: var(--text-secondary);
}
.input-group input {
  width: 80px;
  padding: 6px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 12px;
}
.input-group select {
  width: 100%;
  padding: 6px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 12px;
  background: white;
}
.input-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0, 113, 220, 0.1);
}
.button-group {
  display: flex;
  gap: 8px;
}
.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}
.btn-primary {
  background: var(--primary);
  color: white;
}
.btn-primary:hover {
  background: #005bb0;
}
.btn-danger {
  background: var(--danger);
  color: white;
}
.btn-danger:hover {
  background: #c91829;
}
.btn-success {
  background: var(--success);
  color: white;
  width: 100%;
  justify-content: center;
  margin-top: 16px;
}
.btn-success:hover {
  background: #27ae60;
}
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
#progress {
  font-size: 12px;
  color: var(--text-secondary);
  margin: 6px 0;
  padding: 6px;
  background: var(--background);
  border-radius: 6px;
  border: 1px solid var(--border);
}
.checkbox-container {
  padding: 8px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.checkbox-container input[type="checkbox"] {
  width: 14px;
  height: 14px;
  cursor: pointer;
}
.checkbox-container label {
  font-size: 12px;
  cursor: pointer;
}
#orderNumbersContainer {
  max-height: 420px;
  overflow-y: auto;
  padding-right: 8px;
}
#orderNumbersContainer h3 {
  font-size: 14px;
  margin-bottom: 8px;
  color: var(--text);
}
/* Custom scrollbar */
#orderNumbersContainer::-webkit-scrollbar {
  width: 4px;
}
#orderNumbersContainer::-webkit-scrollbar-track {
  background: var(--background);
  border-radius: 4px;
}
#orderNumbersContainer::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}
#orderNumbersContainer::-webkit-scrollbar-thumb:hover {
  background: #999;
}
#downloadProgress {
  font-size: 12px;
  color: var(--text-secondary);
  margin: 12px 0;
  padding: 12px;
  background: var(--background);
  border-radius: 6px;
  border: 1px solid var(--border);
}
.loading-spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid #ffffff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
.faq-button {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background-color: var(--background);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-size: 12px;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s ease;
  margin-left: auto;
  cursor: pointer;
}
.faq-button:hover {
  background-color: var(--primary);
  border-color: var(--primary);
  color: white;
}
.faq-button:hover svg {
  stroke: white;
}
.faq-button svg {
  stroke: var(--text);
  transition: stroke 0.2s ease;
}
.btn-clear {
  background: var(--background);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-clear:hover {
  background: #e5e7eb;
}
.cache-info {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
  padding: 4px 8px;
  background: #f0f9ff;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.cache-info svg {
  flex-shrink: 0;
}
.cache-time {
  font-style: italic;
  margin-top: 2px;
  font-size: 10px;
}
.rating-hint {
  position: relative;
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 8px;
  padding: 6px 8px;
  background: #f0f9ff;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  transition: opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s;
}
.rating-hint.show {
  opacity: 1;
  max-height: 40px;
  padding: 6px 8px;
}
.rating-hint a {
  color: var(--primary);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.rating-hint a:hover {
  text-decoration: underline;
}
.dismiss-hint {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.dismiss-hint:hover {
  color: var(--text);
}
.order-label {
  position: relative;
  display: inline-block;
}
.info-icon {
  color: var(--primary);
  font-size: 10px;
  margin-left: 4px;
}
.order-tooltip {
  visibility: hidden;
  background-color: #333;
  color: white;
  text-align: center;
  padding: 5px 8px;
  border-radius: 4px;
  position: absolute;
  z-index: 1;
  top: 150%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
  white-space: nowrap;
  font-size: 11px;
  max-width: 300px;
  word-wrap: break-word;
  pointer-events: none;
}
.order-tooltip::after {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #333 transparent;
}
.order-label:hover .order-tooltip {
  visibility: visible;
  opacity: 1;
}
</file>

<file path="background.js">
let allOrderNumbers = new Set();
let allAdditionalFields = {};
let currentPage = 1;
let isCollecting = false;
let tabId = null;
let maxRetries = 3;
let retryCount = 0;
let pageLimit = 0;
let timeout = 100;
let cacheKey = "walmart_order_cache";
let pagesCached = {};
// Cache expiration time (24 hours in milliseconds)
const CACHE_EXPIRATION = 24 * 60 * 60 * 1000;
// Function to load cached order data
function loadCachedOrderNumbers() {
  return new Promise((resolve) => {
    chrome.storage.session.get([cacheKey], (result) => {
      if (result[cacheKey]) {
        const cachedData = result[cacheKey];
        // Check if cache is expired
        if (Date.now() - cachedData.timestamp > CACHE_EXPIRATION) {
          console.log("Cache is expired. Clearing.");
          chrome.storage.session.remove(cacheKey);
          allOrderNumbers = new Set();
          allAdditionalFields = {};
          pagesCached = {};
        } else {
          allOrderNumbers = new Set(cachedData.orderNumbers);
          allAdditionalFields = cachedData.additionalFields || {};
          pagesCached = cachedData.pagesCached || {};
          console.log(`Loaded ${allOrderNumbers.size} orders from cache with ${Object.keys(pagesCached).length} pages cached`);
        }
      }
      resolve();
    });
  });
}
// Function to save order data to cache
function saveToCache() {
  const dataToCache = {
    orderNumbers: Array.from(allOrderNumbers),
    additionalFields: allAdditionalFields,
    pagesCached: pagesCached,
    timestamp: Date.now(),
  };
  chrome.storage.session.set({ [cacheKey]: dataToCache }, () => {
    console.log(`Saved ${allOrderNumbers.size} orders and ${Object.keys(pagesCached).length} pages to cache`);
  });
}
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === "startCollection") {
    if (!isCollecting) {
      isCollecting = true;
      // Load cached order numbers before starting collection
      loadCachedOrderNumbers().then(() => {
        currentPage = 1;
        retryCount = 0;
        pageLimit = request.pageLimit || 0;
        startCollection(request.url);
      });
    }
    sendResponse({ status: "started" });
  } else if (request.action === "stopCollection") {
    if (isCollecting) {
      isCollecting = false;
      if (tabId) {
        chrome.tabs.remove(tabId);
        chrome.tabs.onUpdated.removeListener(onTabUpdated);
      }
      // Save to cache before sending response
      saveToCache();
      sendResponse({
        status: "stopped",
        currentPage: currentPage,
        orderNumbers: Array.from(allOrderNumbers),
      });
    }
  } else if (request.action === "getProgress") {
    loadCachedOrderNumbers().then(() => {
      sendResponse({
        currentPage: currentPage,
        pageLimit: pageLimit,
        orderNumbers: Array.from(allOrderNumbers),
        additionalFields: allAdditionalFields,
        isCollecting: isCollecting,
        pagesCached: pagesCached,
      });
    });
    return true; // Indicate async response
  } else if (request.action === "clearCache") {
    chrome.storage.session.clear(() => {
      // Clear all session storage
      console.log("Cache cleared");
      allOrderNumbers.clear();
      pagesCached = {};
      sendResponse({ status: "cache_cleared" });
    });
    return true; // Indicate async response
  }
  return true;
});
function startCollection(url) {
  console.log("Starting collection from URL:", url);
  chrome.tabs.create({ url: url, active: false }, (tab) => {
    tabId = tab.id;
    chrome.tabs.onUpdated.addListener(onTabUpdated);
  });
}
function onTabUpdated(updatedTabId, changeInfo, tab) {
  if (updatedTabId === tabId && changeInfo.status === "complete") {
    console.log("Tab updated, collecting order numbers for page:", currentPage);
    setTimeout(() => collectOrderNumbers(), timeout);
  }
}
function collectOrderNumbers() {
  if (!isCollecting) {
    console.log("Collection stopped by user");
    finishCollection();
    return;
  }
  // Check if we've reached the page limit
  if (pageLimit > 0 && currentPage > pageLimit) {
    console.log(`Reached page limit (${pageLimit}). Finishing collection.`);
    finishCollection();
    return;
  }
  // Check if this page is already cached
  if (pagesCached[currentPage]) {
    console.log(`Page ${currentPage} is already cached. Skipping collection.`);
    // If already cached, we can go to the next page
    if (pagesCached[currentPage].hasNextPage && (pageLimit === 0 || currentPage < pageLimit)) {
      currentPage++;
      goToNextPage();
    } else {
      console.log("No more pages to collect or reached limit. Finishing collection.");
      finishCollection();
    }
    return;
  }
  chrome.tabs.sendMessage(tabId, { action: "collectOrderNumbers" }, (response) => {
    if (chrome.runtime.lastError) {
      console.error("Error collecting order numbers:", chrome.runtime.lastError);
      retryCollection();
      return;
    }
    if (response && response.orderNumbers) {
      console.log(`Collected ${response.orderNumbers.length} order numbers from page ${currentPage}`);
      // Add order numbers to the set
      response.orderNumbers.forEach((num) => allOrderNumbers.add(num));
      // Add additional fields to the map
      if (response.additionalFields) {
        allAdditionalFields = { ...allAdditionalFields, ...response.additionalFields };
      }
      // Cache page data
      pagesCached[currentPage] = {
        hasNextPage: response.hasNextPage,
        orderNumbers: response.orderNumbers,
        additionalFields: response.additionalFields || {},
        timestamp: Date.now(),
      };
      // Save to cache after each page
      saveToCache();
      if (response.hasNextPage && (pageLimit === 0 || currentPage < pageLimit)) {
        currentPage++;
        retryCount = 0;
        goToNextPage();
      } else {
        console.log("No more pages to collect or reached limit. Finishing collection.");
        finishCollection();
      }
    } else {
      console.log("No order numbers received. Retrying.");
      retryCollection();
    }
  });
}
function goToNextPage() {
  if (!isCollecting) {
    finishCollection();
    return;
  }
  console.log("Attempting to go to next page:", currentPage);
  chrome.tabs.sendMessage(tabId, { action: "clickNextButton" }, (response) => {
    if (chrome.runtime.lastError) {
      console.error("Error clicking next button:", chrome.runtime.lastError);
      retryCollection();
    } else if (response && response.success) {
      console.log("Successfully clicked next button. Waiting for page to load.");
    } else {
      console.log("Failed to click next button. Retrying.");
      retryCollection();
    }
  });
}
function retryCollection() {
  if (!isCollecting) {
    finishCollection();
    return;
  }
  if (retryCount < maxRetries) {
    retryCount++;
    console.log(`Retrying collection. Attempt ${retryCount} of ${maxRetries}`);
    setTimeout(() => collectOrderNumbers(), timeout);
  } else {
    console.log("Max retries reached. Finishing collection.");
    finishCollection();
  }
}
function finishCollection() {
  isCollecting = false;
  // Save to cache before closing
  saveToCache();
  if (tabId) {
    chrome.tabs.onUpdated.removeListener(onTabUpdated);
    chrome.tabs.remove(tabId);
  }
  console.log(`Collection finished. Total pages: ${currentPage}, Total order numbers: ${allOrderNumbers.size}`);
}
</file>

<file path="README.md">
# Walmart Invoice Exporter

A Chrome extension that allows users to download their Walmart order history in XLSX format. Now with invoice caching, flexible export modes, and advanced performance optimizations!

<img src="./screenshot.webp" alt="Screenshot of extension" height="200">

## Features

- **Invoice Caching**: Downloaded invoices are automatically cached locally for instant re-access without re-downloading
- **Flexible Export Modes**: Choose between downloading individual files (one per order) or a combined single file with all items
- **Batch Download**: Select and download multiple order invoices at once
- **Page Crawling**: Automatically collect order numbers from your order history with customizable page limits
- **Smart Caching System**: Stores previously collected orders for faster repeat access or accidental closure (24-hour cache expiration)
- **Order Description Tooltips**: Hover over order numbers to see their delivery date or status
- **Smart Image Blocking**: Automatically blocks images during processing to improve speed and reduce network usage
- **Customizable Limits**: Set how many pages of order history to crawl (0 = unlimited)
- **Cache Management**: Per-order invoice cache indicators and ability to clear individual order caches
- **Detailed Excel Format**: Each invoice includes:
  - Product details (name, quantity, price)
  - Delivery status
  - Product links
  - Order information (number, date)
  - Additional charges (delivery, tax, tip)
- **Secure & Efficient**: Runs only on Walmart's orders pages with minimal required permissions
- **Centralized Configuration**: Maintains consistent selectors and styling throughout the extension using centralized constants

## Technical Details

- **Manifest V3**: Uses Chrome's latest manifest version for security and reliability
- **Permissions**:
  - `ActiveTabs` - Required for order page access and invoice downloads
  - `Storage` - Used for local storage of invoice cache and preferences
  - Host permissions for `https://www.walmart.com/*`
- **Caching System**:
  - Session storage for order numbers (24-hour auto-expiration)
  - Local storage for downloaded invoice data with per-order cache management
  - Page-level caching to avoid redundant API calls during collection
- **Order Format Support**:
  - Regular orders (13 or 15 digits)
  - In-store purchases (20+ digits)
  - Various order statuses (delivered, canceled, returned)
- **Excel Generation**: Implements ExcelJS for robust XLSX file creation
  - Support for single order exports with complete order summary
  - Multi-order consolidated exports combining all items into one sheet
  - Proper formatting with headers, fonts, and hyperlinks
- **Performance Optimizations**:
  - Aggressive image blocking (CSS, HTML elements, background images)
  - Content Security Policy implementation
  - Throttling between downloads to prevent rate limiting
  - Automatic retry with configurable timeout
  - Memory cleanup after each operation
- **Background Service Worker**: Efficient handling of collection and caching operations
- **Content Script Integration**: Direct DOM manipulation for order extraction with image blocking

## Performance Features

- **Invoice Caching**: Once downloaded, invoices are stored in local storage for instant re-access without re-downloading
- **Order Collection Caching**: Orders are cached for 24 hours with automatic expiration
- **Page Caching**: Already processed pages are skipped during collection to prevent redundant API calls
- **Smart Image Blocking**: Aggressive blocking strategy targeting:
  - HTML `<img>` and `<picture>` elements
  - CSS background images and inline styles
  - Content Security Policy enforcement
  - Image constructor override
- **Throttling**: Configurable delays between downloads to prevent walmart.com rate limiting
- **Memory Optimization**: Automatic cleanup of resources after each order download
- **Background Processing**: Efficient handling of multiple downloads using browser background tabs
- **Smart Retries**: Automatic retry attempts with exponential backoff for failed downloads
- **Per-Order Cache Management**: Visual indicators show cached orders with ability to clear individual caches

## Limitations

- Works only on Walmart's order pages
- Download speed may vary based on network conditions
- Large batch downloads may take several minutes to complete
- Requires stable and fast internet connection for bulk downloads

## Installation

### From Chrome Web Store

Install the Walmart Invoice Exporter directly from the [Chrome Web Store](https://chromewebstore.google.com/detail/walmart-invoice-exporter/bndkihecbbkoligeekekdgommmdllfpe).

### Manual Installation

1. Download or clone this repository
2. Open Chrome and go to `chrome://extensions/`
3. Enable "Developer mode" in the top-right corner
4. Click "Load unpacked" and select the extension directory
5. Pin the extension to your toolbar for easy access

## What's New

### [Changelog](./CHANGELOG.md)

## Usage

### Single Order Download

1. Navigate to a specific Walmart order page
2. Click the extension icon
3. Click "Download Invoice"

### Batch Download with Export Modes

The extension offers two export modes for batch downloads:

#### Export Mode 1: Multiple Files (Default)
Downloads one XLSX file per order, each containing the full order details and summary.

#### Export Mode 2: Single Combined File
Downloads all selected orders into a single XLSX file with all items combined in one spreadsheet.

**To Use Batch Download:**

1. Go to your Walmart order history page (https://www.walmart.com/orders)
2. Click the extension icon
3. **(Optional)** Select your preferred export mode from the "Export mode" dropdown:
   - "Multiple files (one per order)" - Each order as a separate file
   - "Single file (all items)" - All items combined into one file
4. Set the number of pages to crawl (0 = unlimited)
5. Click "Start Collection"
6. Wait for the order numbers to load (may take a few seconds depending on page count)
7. Hover over order numbers to see their descriptions (delivery date, status) if needed
8. Look for the **cache icon** (📦) next to orders that have been previously downloaded - click to clear individual order caches if needed
9. Select the orders you want to download
10. Click the appropriate download button:
    - "Download Selected Orders" (for multiple files mode)
    - "Download as Single File" (for single file mode)
11. Wait for the downloads to complete

**Cache Management:**

- Downloaded invoices show a cache icon (📦) next to the order number
- Click the cache icon to clear that specific order's cached invoice
- Use the "Clear All Cache" button to clear all cached data at once
- Cached data automatically expires after 24 hours

## Troubleshooting

### Required Chrome Settings for Downloads

Before using the download feature, make sure to configure Chrome settings:

#### 1. Configure Download Settings:

- Open Chrome Settings or paste the following link in the address bar:

```
chrome://settings/downloads
```

- Click on "Downloads" in the left sidebar if not already selected
- Turn OFF "Ask where to save each file before downloading"
- Turn OFF "Show downloads when they're done"

#### 2. Enable Automatic Downloads:

```
chrome://settings/content/siteDetails?site=https%3A%2F%2Fwww.walmart.com#:~:text=Automatic%20downloads
```

- Open a new Chrome tab and paste the above link
- Find "Automatic downloads" option
- Set it to "Allow" (instead of Ask or Block)

#### Alternative Method: (If the above link doesn't work):

```
chrome://settings/content/automaticDownloads
```

- Open a new Chrome tab and paste the above link
- Under "**Allowed to automatically download multiple files**", click Add
- Enter `[*.]walmart.com` and click Add

> **Important**: All these settings are required for bulk downloads to work properly. Make sure to add walmart.com under "**Allowed to automatically download multiple files**" and NOT under "Not allowed to automatically download multiple files"

### Common Issues

**Issue: Popup appears but no orders are shown**
- Solution: Refresh the Walmart orders page and try again
- The cache is automatically loaded if available; otherwise, click "Start Collection"

**Issue: Download takes too long**
- Solution: Try downloading fewer orders at a time (5-10 orders initially)
- Check your internet connection speed
- Close unnecessary browser tabs and programs

**Issue: Some orders fail to download in batch mode**
- Solution: The extension will automatically retry failed orders
- Try downloading those specific orders individually
- Check the console (F12 > Console tab) for error details

**Issue: Cache icon appears but files won't re-download**
- Solution: Try clearing that specific order's cache by clicking the cache icon
- If needed, clear all caches and re-download

**Issue: Single file mode combines orders but items are not organized**
- Solution: The single file mode intentionally combines all items in one sheet
- If you need separate sheets per order, switch to "Multiple files" mode

**Getting Help:**

1. Read the FAQ in the extension popup ("Help & FAQ" button) for detailed guides
2. Check that the extension has necessary permissions
3. Verify Chrome download settings as described above
4. For batch downloads, start with smaller batches to identify issues
5. If you're still facing issues, please submit a detailed bug report with:
   - Screenshot of the error
   - Number of orders attempted
   - Your Chrome version
   - The browser console output (F12 > Console)

## Performance Tips

For best results when using the extension:

### During Order Collection:
1. Start with the default "0" (unlimited) page setting or a smaller number (2-5) to test
2. Don't close the popup or switch windows during collection
3. Keep the browser window active and focused
4. On slower connections, the collection may take time - be patient

### During Batch Downloads:
1. Close unnecessary browser tabs and applications
2. Start with smaller batches (5-10 orders)
3. Ensure stable and fast internet connection
4. For "Single file" mode with large selections, processing time increases with order count
5. Allow the extension to complete its process without interruptions
6. Keep the popup window open during downloads

### Cache Management:
1. Regularly check for cached orders (indicated by cache icons 📦)
2. Clear individual order caches when you want fresh data
3. Use "Clear All Cache" at the beginning of each month for a fresh start
4. Cache is automatically cleared after 24 hours

### Export Mode Selection:
1. Use **"Multiple files"** mode for easier organization and quick downloads
2. Use **"Single file"** mode when you need all items consolidated for analysis
3. You can switch between modes anytime - the preference is saved

## Contributing

Contributions welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Commit your changes
4. Push to the branch
5. Submit a Pull Request

## Architecture

The extension is built with a modular design for maintainability:

**Core Files:**
- `manifest.json` - Extension configuration and permissions
- `popup.html/popup.js/popup.css` - User interface and main logic
- `background.js` - Background service worker for collection and caching
- `content.js` - Content script for DOM manipulation on Walmart pages
- `utils.js` - Shared utility functions for Excel generation and styling

**Key Components:**
1. **Cache System** - Manages order number caching and invoice storage
2. **Collection Engine** - Crawls Walmart pages to extract order numbers
3. **Export Engines** - Handles both single and multiple file export modes
4. **UI Controller** - Manages popup interface and user interactions
5. **Performance Optimizer** - Implements image blocking and throttling

**Data Flow:**
1. User initiates collection from popup
2. Background worker opens collection tab and sends messages to content script
3. Content script extracts order numbers and sends them back
4. Orders are cached locally and displayed in popup
5. User selects orders and initiates download
6. Background worker or popup processes each order and creates Excel files
7. Files are cached for future quick re-access

## Version History

For a complete list of changes, see [CHANGELOG.md](./CHANGELOG.md)

**Latest Features (v4.0):**
- Invoice caching for instant re-access
- Centralized configuration constants
- Enhanced cache management with per-order indicators

## Support

For issues or feature requests, please:

1. Check existing issues in the repository
2. Submit a new issue if needed
3. Include specific details about the problem

## Privacy & Data Security

This extension prioritizes your privacy and security:

**Data Storage:**
- Order numbers are stored in Chrome's session storage (temporary)
- Invoice data is stored in Chrome's local storage (on your device only)
- Order cache automatically expires after 24 hours
- No data is sent to external servers

**Only Runs On:**
- Walmart's order pages (`https://www.walmart.com/orders*`)
- Cannot access other websites or your browsing history

**Permissions Explanation:**
- `activeTab` - Allows the extension to access the current Walmart order page
- `storage` - Allows local caching of invoices and preferences on your device
- `host_permissions` for `walmart.com` - Required to access Walmart order data

**Data Processing:**
- All PDF parsing and Excel generation happens locally in your browser
- Images are blocked for performance (not accessed or stored)
- No tracking or analytics implemented
- No cookies or external API calls

**Your Control:**
- You can clear all cached data anytime using the "Clear All Cache" button
- You can delete individual order caches by clicking the cache icon
- Cache is always under your control in your browser's storage

## Acknowledgments

Special thanks to all the users who provided feedback for making this extension more efficient and user-friendly. This project is continually improved based on community feedback and real-world usage patterns.

**Dependencies:**
- [ExcelJS](https://github.com/exceljs/exceljs) - For robust XLSX file generation

## License

MIT License - feel free to use and modify as needed.
</file>

<file path="popup.html">
<!DOCTYPE html>
<html>
<head>
    <title>Walmart Invoice Exporter</title>
    <link rel="stylesheet" href="popup.css">
    <script src="exceljs.bare.min.js"></script>
    <script src="utils.js"></script>
</head>
<body>
    <div class="header">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path
                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h1>Walmart Invoice Exporter</h1>
        <button id="faqButton" class="faq-button">
            <svg width="16" height="16" viewBox="0 0 29.536 29.536" fill="currentColor">
                <g>
                    <path d="M14.768,0C6.611,0,0,6.609,0,14.768c0,8.155,6.611,14.767,14.768,14.767s14.768-6.612,14.768-14.767
                        C29.535,6.609,22.924,0,14.768,0z M14.768,27.126c-6.828,0-12.361-5.532-12.361-12.359c0-6.828,5.533-12.362,12.361-12.362
                        c6.826,0,12.359,5.535,12.359,12.362C27.127,21.594,21.594,27.126,14.768,27.126z"
                        stroke="currentColor" stroke-width="0.5" />
                    <path d="M14.385,19.337c-1.338,0-2.289,0.951-2.289,2.34c0,1.336,0.926,2.339,2.289,2.339c1.414,0,2.314-1.003,2.314-2.339
                        C16.672,20.288,15.771,19.337,14.385,19.337z" stroke="currentColor" stroke-width="0.5" />
                    <path
                        d="M14.742,6.092c-1.824,0-3.34,0.513-4.293,1.053l0.875,2.804c0.668-0.462,1.697-0.772,2.545-0.772
                        c1.285,0.027,1.879,0.644,1.879,1.543c0,0.85-0.67,1.697-1.494,2.701c-1.156,1.364-1.594,2.701-1.516,4.012l0.025,0.669h3.42
                        v-0.463c-0.025-1.158,0.387-2.162,1.311-3.215c0.979-1.08,2.211-2.366,2.211-4.321C19.705,7.968,18.139,6.092,14.742,6.092z"
                        stroke="currentColor" stroke-width="0.5" />
                </g>
            </svg>
            <b>Help & FAQ</b>
        </button>
    </div>
    <div class="card">
        <div class="input-group" id="pageLimitGroup">
            <label for="pageLimit">Number of pages to crawl (0 = unlimited)</label>
            <input type="number" id="pageLimit" min="0" value="0">
        </div>
        <div class="input-group" id="exportModeGroup">
            <label for="exportMode">Export mode</label>
            <select id="exportMode">
                <option value="multiple">Multiple files (one per order)</option>
                <option value="single">Single file (all items)</option>
            </select>
        </div>
        <div class="button-group" id="buttonGroup">
            <button id="startCollection" class="btn btn-primary">
                <span class="btn-text">Start Collection</span>
            </button>
            <button id="stopCollection" class="btn btn-danger" style="display: none;">
                Stop Collection
            </button>
        </div>
    </div>
    <div id="progress"></div>
    <div id="orderNumbersContainer"></div>
    <script src="popup.js"></script>
</body>
</html>
</file>

<file path="CHANGELOG.md">
# Changelog

## [4.0] - November 16, 2025
- **Feature:** Implemented caching for invoice data in Chrome local storage after the first download. Subsequent downloads check the cache first and use cached data if available, significantly speeding up the process.
- **Enhancement:** Refactored code to use centralized constants for selectors, text, and CSS classes in `utils.js` for better maintainability.

## [3.3] - November 15, 2025
- **Fix:** Resolved issue with order number extraction due to changes in Walmart's order history page structure.

## [3.2] - August 9, 2025

- **Feature:** Added Export mode selector (Multiple files or Single combined file)
  - New option in the popup to choose between downloading one XLSX per order or a single XLSX containing all selected orders
  - Combined export is processed sequentially in one background tab for reliability
  - Uses ExcelJS in the popup to generate a single workbook with all items
- **Enhancement:** Content script now supports structured data retrieval (no download) to power combined export
- **Note:** Existing multiple-file download flow remains unchanged

## [3.1] - March 25, 2025

- **Enhancement:** Added order description tooltip functionality
  - Hover over order numbers to see order delivery date or if it's canceled or returned order
  - Displays order delivery date from order history without downloading the order invoice
  - Makes identifying and selecting specific orders much easier

## [3.0] - March 25, 2025

- **Feature:** Implemented session storage caching system
  - Automatically stores previously collected order numbers
  - Dramatically improves loading time for repeat usage
  - Shows cache timestamp and source information
  - Includes option to clear cache when fresh data is needed
  - Cache automatically expires after 24 hours
- **Enhancement:** Improved memory management during order collection
- **Enhancement:** Updated FAQ with information about the caching system

## [2.5] - January 5, 2025

- **Enhancement:** Improved performance by blocking image loading in background tabs
  - Faster page loading during order collection and invoice download
  - Reduced network usage

## [2.4] - January 5, 2025

- **Enhancement:** Feature: Added comprehensive FAQ page with troubleshooting guides
  - Step-by-step instructions for single and batch downloads
  - Chrome settings configuration guide for bulk downloads
  - Common issues and solutions
  - Guide for merging multiple Excel files

## [2.3] - December 19, 2024

- **Fixed:** Resolved an issue with failed invoice downloads for new in-store orders.

## [2.2] - December 5, 2024

- **Enhancement:** Walmart orders page link clickable in popup.

## [2.1] - December 1, 2024

- **Enhancement:** Improved UI.

## [2.0] - November 26, 2024

- **Feature:** Added support for downloading multiple invoices at once.
- **Feature:** Introduced new order history crawler.
- **Update:** Improved invoice downloading system.
- **Enhancement:** Enhanced user interface with progress tracking.

## [1.4.1] - August 30, 2024

- **Update:** Improved order number extraction to handle various formats, including in-store purchases.

## [1.4] - August 29, 2024

- **Enhancement:** Improved invoice parsing using print-bill classes for better order delivery status accuracy.
- **Feature:** Added tip, tax, and delivery charges to the exported invoice.
- **Update:** Separated product name and links into different columns in the Excel file.

## [1.3] - August 27, 2024

- **Fixed:** Resolved an issue where xlsx invoice files were not downloading.
- **Update:** Changed the extension name to Walmart Invoice Exporter.
</file>

<file path="content.js">
const OrderNumberRegex = /#\s*([\d-]+)/;
let allOrderNumbers = new Set();
let currentPage = 0;
let isProcessing = false;
function removeAllImages() {
  // Remove background images from elements
  const allElements = document.getElementsByTagName("*");
  for (let element of allElements) {
    if (element.style) {
      element.style.backgroundImage = "none";
    }
  }
  // Remove all img elements
  const images = document.querySelectorAll("img");
  images.forEach((img) => {
    img.remove();
  });
  // Remove picture elements
  const pictures = document.querySelectorAll("picture");
  pictures.forEach((pic) => {
    pic.remove();
  });
  // Remove CSS background images
  const styleSheets = Array.from(document.styleSheets);
  styleSheets.forEach((sheet) => {
    try {
      const rules = Array.from(sheet.cssRules || sheet.rules);
      rules.forEach((rule, index) => {
        if (rule.style && rule.style.backgroundImage) {
          rule.style.backgroundImage = "none";
        }
      });
    } catch (e) {
      // Handle cross-origin stylesheet errors silently
    }
  });
}
function blockImageLoading() {
  // Override Image constructor
  const originalImage = window.Image;
  window.Image = function () {
    const dummyImage = {};
    Object.defineProperty(dummyImage, "src", {
      set: function () {
        return "";
      },
      get: function () {
        return "";
      },
    });
    return dummyImage;
  };
  // Block image loading using Content-Security-Policy
  const meta = document.createElement("meta");
  meta.setAttribute("http-equiv", "Content-Security-Policy");
  meta.setAttribute("content", "img-src 'none'"); // Fixed CSP directive
  document.head.appendChild(meta);
  // Prevent loading through srcset
  HTMLImageElement.prototype.setAttribute = new Proxy(HTMLImageElement.prototype.setAttribute, {
    apply(target, thisArg, argumentsList) {
      const [attr] = argumentsList;
      if (attr === "src" || attr === "srcset") {
        return;
      }
      return Reflect.apply(target, thisArg, argumentsList);
    },
  });
  // Intercept image loading
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      mutation.addedNodes.forEach((node) => {
        if (node.nodeName === "IMG" || node.nodeName === "PICTURE") {
          node.remove();
        }
        if (node.getElementsByTagName) {
          const images = node.getElementsByTagName("img");
          const pictures = node.getElementsByTagName("picture");
          Array.from(images).forEach((img) => img.remove());
          Array.from(pictures).forEach((pic) => pic.remove());
        }
      });
    });
  });
  observer.observe(document.documentElement, {
    childList: true,
    subtree: true,
  });
}
function aggressiveImageBlocking() {
  // Add style to hide images immediately
  removeAllImages();
  blockImageLoading();
  // Additional cleanup passes
  setTimeout(removeAllImages, 500);
  setTimeout(removeAllImages, 1000);
}
// Function to wait for an element to appear
async function waitForElement(selector, timeout = 30000) {
  const startTime = Date.now();
  while (Date.now() - startTime < timeout) {
    const element = document.querySelector(selector);
    if (element) {
      return element;
    }
    await new Promise((resolve) => setTimeout(resolve, 500));
  }
  throw new Error(`Element ${selector} not found after ${timeout}ms`);
}
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === "collectOrderNumbers") {
    // Handle collection asynchronously
    aggressiveImageBlocking();
    handleCollectOrderNumbers().then(sendResponse);
    return true; // Indicates we'll send response asynchronously
  } else if (request.action === "clickNextButton") {
    // Handle next button click asynchronously
    aggressiveImageBlocking();
    handleClickNextButton().then(sendResponse);
    return true;
  } else if (request.action === "blockImagesForDownload") {
    aggressiveImageBlocking();
    sendResponse({ success: true });
    return true;
  } else if (request.method === "downloadXLSX") {
    aggressiveImageBlocking();
    const data = scrapeOrderData();
    // Convert the order details to an XLSX file using the shared convertToXlsx function
    convertToXlsx(data, ExcelJS, { mode: 'single' });
    sendResponse({ data });
  } else if (request.method === 'getOrderData') {
    aggressiveImageBlocking();
    const data = scrapeOrderData();
    sendResponse({ data });
  }
  return true;
});
function scrapeOrderData() {
  // Array to store all order items
  let orderItems = [];
  // Select all elements representing the print items list
  let printItemsList = document.querySelectorAll(CONSTANTS.SELECTORS.PRINT_ITEMS);
  // Loop through each item in the print items list
  printItemsList.forEach((item) => {
    let productName = item.querySelector(CONSTANTS.SELECTORS.PRINT_ITEM_NAME)?.innerText;
    let deliveryStatus = item.querySelector(CONSTANTS.SELECTORS.PRINT_BILL_TYPE)?.innerText || CONSTANTS.TEXT.DELIVERY_LABEL;
    let quantity = item.querySelector(CONSTANTS.SELECTORS.PRINT_BILL_QTY)?.innerText;
    let price = item.querySelector(CONSTANTS.SELECTORS.PRINT_BILL_PRICE)?.innerText;
    // Find the corresponding visible item to get the product link
    let productLink = "N/A";
    let visibleItems = document.querySelectorAll(CONSTANTS.SELECTORS.VISIBLE_ITEMS);
    for (let visibleItem of visibleItems) {
      if (visibleItem?.innerText.trim() === (productName || '').trim()) {
        let linkElement = visibleItem.closest(CONSTANTS.SELECTORS.ITEM_STACK).querySelector(CONSTANTS.SELECTORS.PRODUCT_LINK);
        if (linkElement) {
          productLink = linkElement.href;
          break;
        }
      }
    }
    // Push the item details into the orderItems array
    orderItems.push({
      productName,
      productLink,
      deliveryStatus,
      quantity,
      price,
    });
  });
  // Function to find the order number based on a list of possible selectors
  function findOrderNumber() {
    const selectors = [
      CONSTANTS.SELECTORS.ORDER_NUMBER_BAR,
      CONSTANTS.SELECTORS.ORDER_INFO_CARD,
      CONSTANTS.SELECTORS.ORDER_NUMBER_HEADING,
      CONSTANTS.SELECTORS.PRINT_BILL_ID,
    ];
    for (let selector of selectors) {
      const element = document.querySelector(selector);
      if (element) {
        const text = element.textContent;
        const match = text.match(CONSTANTS.ORDER_NUMBER_REGEX);
        if (match) {
          return match[1];
        }
      }
    }
    console.log("Order number not found with current selectors");
    return null;
  }
  // Extract additional order details
  let orderNumber = findOrderNumber();
  let orderDate = document.querySelector(CONSTANTS.SELECTORS.ORDER_DATE)?.innerText || '';
  orderDate = orderDate.replace("order", "").trim();
  let orderTotal = document.querySelector(CONSTANTS.SELECTORS.ORDER_TOTAL)?.innerText || '';
  let deliveryCharges = document.querySelector(CONSTANTS.SELECTORS.DELIVERY_CHARGES)?.innerText || "$0.00";
  // Find tax by looking for the text "Tax" and getting the corresponding amount
  let tax = "$0.00";
  const taxElements = document.querySelectorAll(CONSTANTS.SELECTORS.TAX_ELEMENTS);
  for (let element of taxElements) {
    if (element.textContent.includes('Tax')) {
      const taxItem = element.closest('.print-fees-item');
      const taxAmount = taxItem?.querySelector('.w_U9_0.w_sD6D.w_QcqU.ml2');
      if (taxAmount) {
        tax = taxAmount.innerText;
        break;
      }
    }
  }
  let tip =
    document.querySelector(".print-bill-payment-section .flex.justify-between.pb2.pt3 .w_U9_0.w_U0S3.w_QcqU:last-child")?.innerText || "$0.00";
  return {
    orderNumber,
    orderDate,
    orderTotal,
    deliveryCharges,
    tax,
    tip,
    items: orderItems,
  };
}
async function handleCollectOrderNumbers() {
  try {
    // Wait for the main heading, which should be present on all pages
    await waitForElement(CONSTANTS.SELECTORS.MAIN_HEADING);
    // It can take a moment for the new order cards to render after a page navigation.
    // We'll wait for at least one order card to be present before scraping.
    await waitForElement('[data-testid^="order-"]');
    const { orderNumbers, additionalFields } = extractOrderNumbers();
    const hasNextPage = await checkForNextPage();
    console.log(`Extracted ${orderNumbers.length} order numbers. Has next page: ${hasNextPage}`);
    return { orderNumbers, additionalFields, hasNextPage };
  } catch (error) {
    console.error("Error during collection:", error);
    // If we timed out waiting for an order, it likely means there are no more.
    if (error.message.includes("not found after")) {
        console.log("No order cards found. Assuming end of orders.");
        return { orderNumbers: [], additionalFields: {}, hasNextPage: false };
    }
    return { orderNumbers: [], additionalFields: {}, hasNextPage: false };
  }
}
async function handleClickNextButton() {
  try {
    // Wait for the Purchase history heading first
    await waitForElement(CONSTANTS.SELECTORS.MAIN_HEADING);
    // Then wait for the next button to be present and clickable
    const nextButton = await waitForElement(CONSTANTS.SELECTORS.NEXT_BUTTON);
    nextButton.click();
    return { success: true };
  } catch (error) {
    console.error("Error clicking next button:", error);
    return { success: false };
  }
}
// Replaced the JSON parsing and old DOM scraping with a single, reliable DOM scraping method.
function extractOrderNumbers() {
  const orderNumbers = [];
  const additionalFields = {};
  // Select all order cards. They all have a `data-testid` starting with "order-"
  const orderCards = document.querySelectorAll(CONSTANTS.SELECTORS.ORDER_CARDS);
  if (orderCards.length === 0) {
      console.warn("No order cards found with selector '[data-testid^=\"order-\"]'");
  }
  orderCards.forEach((card, index) => {
    try {
      // Find the main H2 title, which contains the status/date.
      // e.g., "Delivered on Oct 29" or "Nov 01, 2025 purchase"
      const titleElement = card.querySelector('h2.w_kV33.w_Sl3f.w_mvVb.f3');
      // Find the "View details" button, which reliably contains the order number in its automation ID.
      const buttonElement = card.querySelector('button[data-automation-id^="view-order-details-link-"]');
      if (!titleElement) {
        console.warn(`Could not find title element for order card ${index}`);
        return; // skip this card
      }
      if (!buttonElement) {
        console.warn(`Could not find button element for order card ${index}`);
        return; // skip this card
      }
      const title = titleElement.textContent.trim();
      const automationId = buttonElement.getAttribute('data-automation-id');
      // Extract the order number from an ID like "view-order-details-link-xxxxxxxxxxx"
      const orderNumber = automationId.replace('view-order-details-link-', '');
      if (orderNumber && title) {
        orderNumbers.push(orderNumber);
        additionalFields[orderNumber] = title;
      } else {
         console.warn(`Failed to parse order number or title for order card ${index}`);
      }
    } catch (e) {
      console.error(`Error processing order card ${index}:`, e);
    }
  });
  return { orderNumbers, additionalFields };
}
async function checkForNextPage() {
  try {
    // Wait for the Purchase history heading first
    await waitForElement(CONSTANTS.SELECTORS.MAIN_HEADING);
    // Then check for the next button
    const nextButton = document.querySelector(CONSTANTS.SELECTORS.NEXT_BUTTON);
    return !!nextButton;
  } catch (error) {
    console.error("Error checking for next page:", error);
    return false;
  }
}
</file>

<file path="manifest.json">
{
  "manifest_version": 3,
  "name": "Walmart Invoice Exporter",
  "version": "4",
  "description": "Download Walmart order details in xlsx format",
  "permissions": ["activeTab", "storage"],
  "host_permissions": ["https://www.walmart.com/*"],
  "background": {
    "service_worker": "background.js"
  },
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "images/icon16.png",
      "48": "images/icon48.png",
      "128": "images/icon128.png",
      "256": "images/icon256.png",
      "512": "images/icon512.png"
    }
  },
  "content_scripts": [
    {
      "matches": ["https://www.walmart.com/orders*"],
      "js": ["utils.js", "content.js", "exceljs.bare.min.js"]
    }
  ],
  "icons": {
    "16": "images/icon16.png",
    "48": "images/icon48.png",
    "128": "images/icon128.png"
  },
  "default_locale": "en",

  "web_accessible_resources": [
    {
      "resources": ["faq.html", "faq.js"],
      "matches": ["https://www.walmart.com/*"]
    }
  ]
}
</file>

<file path="popup.js">
let allOrderNumbers = new Set();
let downloadInProgress = false;
let timeout = 1000;
let exportMode = 'multiple'; // 'multiple' | 'single'
document.addEventListener("DOMContentLoaded", function () {
  const startButton = document.getElementById("startCollection");
  const stopButton = document.getElementById("stopCollection");
  const progressElement = document.getElementById("progress");
  const orderNumbersContainer = document.getElementById("orderNumbersContainer");
  const pageLimitInput = document.getElementById("pageLimit");
  const exportModeSelect = document.getElementById("exportMode");
  progressElement.style.display = "none";
  document.getElementById("faqButton").addEventListener("click", function (e) {
    e.preventDefault();
    chrome.tabs.create({
      url: chrome.runtime.getURL("faq/faq.html"),
    });
  });
  // Add loading spinner function
  function setButtonLoading(button, isLoading) {
    const btnText = button.querySelector(".btn-text");
    if (isLoading) {
      button.disabled = true;
      if (!button.querySelector(".loading-spinner")) {
        const spinner = document.createElement("span");
        spinner.className = "loading-spinner";
        button.insertBefore(spinner, btnText);
      }
    } else {
      button.disabled = false;
      const spinner = button.querySelector(".loading-spinner");
      if (spinner) spinner.remove();
    }
  }
  // Initialize export mode from storage
  chrome.storage.local.get(['exportMode'], (res) => {
    exportMode = res.exportMode || 'multiple';
    if (exportModeSelect) exportModeSelect.value = exportMode;
  });
  if (exportModeSelect) {
    exportModeSelect.addEventListener('change', () => {
      exportMode = exportModeSelect.value;
      chrome.storage.local.set({ exportMode });
      // Update button label if present
      const btn = document.getElementById('downloadButton');
      if (btn) {
        const label = exportMode === 'single' ? 'Download as Single File' : 'Download Selected Orders';
        btn.lastChild.nodeValue = ` ${label}`; // Keep icon, change text
      }
    });
  }
  chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
    var tab = tabs[0];
    var url = tab.url;
    if (url.startsWith("https://www.walmart.com/orders")) {
      const cleanUrl = url.replace(/\/$/, "");
      const orderPath = cleanUrl.split("/orders/")[1];
      // Check if there's an order number after /orders/
      if (orderPath && /^\d{10,}$/.test(orderPath.split("?")[0])) {
        // Individual order page - do NOT use cache, only show current order
        const orderNumber = orderPath.split("?")[0];
        console.log("Valid order number:", orderNumber);
        displayOrderNumbers([orderNumber]);
        // Hide unnecessary UI elements
        // document.querySelector(".card").style.display = "none";
        // hide div with id pageLimitGroup and buttonGroup
        document.getElementById("pageLimitGroup").style.display = "none";
        document.getElementById("buttonGroup").style.display = "none";
        document.getElementById("progress").style.display = "none";
        document.getElementsByClassName("checkbox-container")[0].style.display = "none";
        // Skip cache loading for individual order pages
      } else {
        // Main orders page setup
        startButton.addEventListener("click", function () {
          const pageLimit = parseInt(pageLimitInput.value, 10);
          startButton.style.display = "none";
          stopButton.style.display = "inline-flex";
          setButtonLoading(startButton, true);
          chrome.runtime.sendMessage(
            {
              action: "startCollection",
              url: url,
              pageLimit: pageLimit,
            },
            function (response) {
              if (response.status === "started") {
                updateProgress();
              }
              setButtonLoading(startButton, false);
            }
          );
        });
        stopButton.addEventListener("click", function () {
          setButtonLoading(stopButton, true);
          chrome.runtime.sendMessage({ action: "stopCollection" }, function (response) {
            if (response.status === "stopped") {
              stopButton.style.display = "none";
              startButton.style.display = "inline-flex";
              startButton.querySelector(".btn-text").textContent = "Restart Collection";
              setButtonLoading(stopButton, false);
            }
          });
        });
        // Load cache only on main orders page
        loadCacheOnMainPage();
      }
    } else {
      document.querySelector(".card").style.display = "none";
      orderNumbersContainer.innerHTML = `
        <div class="card" style="text-align: center; padding: 24px;">
          ${renderIcon('ERROR_LARGE')}
          <p style="color: var(--text); font-size: 16px; margin-bottom: 8px;">Please navigate to</p>
          <p style="color: var(--primary); font-weight: 500; margin-bottom: 16px;"><a href="${CONSTANTS.URLS.WALMART_ORDERS}" target="_blank">walmart.com/orders</a></p>
          <p style="color: var(--text-secondary); font-size: 14px;">to use this extension.</p>
        </div>`;
    }
  });
  // Add clear cache button
  const clearCacheButton = document.createElement("button");
  clearCacheButton.id = "clearCache";
  clearCacheButton.className = CONSTANTS.CSS_CLASSES.BTN_CLEAR;
  clearCacheButton.innerHTML = `
    ${renderIcon('TRASH')}
    <span class="btn-text">${CONSTANTS.TEXT.CLEAR_CACHE_BTN}</span>
  `;
  // Insert clear cache button into the button group
  const buttonGroup = document.querySelector(".button-group");
  buttonGroup.appendChild(clearCacheButton);
  // Add clear cache functionality
  clearCacheButton.addEventListener("click", async function () {
    setButtonLoading(clearCacheButton, true);
    // Clear invoice cache
    await clearAllInvoiceCache();
    chrome.runtime.sendMessage({ action: "clearCache" }, function (response) {
      if (response.status === "cache_cleared") {
        setButtonLoading(clearCacheButton, false);
        // Update the UI to show no orders
        displayOrderNumbers([]);
        // Show a message
        const progressElement = document.getElementById("progress");
        progressElement.textContent = "Cache cleared successfully";
        progressElement.style.display = "block";
        // Hide the message after 2 seconds
        setTimeout(() => {
          progressElement.style.display = "none";
        }, 2000);
      }
    });
  });
});
// Function to load cache only on the main orders page
function loadCacheOnMainPage() {
  // Check for cached data on popup open
  chrome.runtime.sendMessage({ action: "getProgress" }, function (response) {
    if (response && response.orderNumbers && response.orderNumbers.length > 0) {
      displayOrderNumbers(response.orderNumbers, response.additionalFields);
      // Show cache info
      const cachePages = Object.keys(response.pagesCached || {}).length;
      const cacheInfo = document.createElement("div");
      cacheInfo.className = "cache-info";
      // Format the cache timestamp
      let cacheTimeInfo = "";
      if (response.pagesCached && Object.keys(response.pagesCached).length > 0) {
        // Find the earliest timestamp from all cached pages
        const timestamps = Object.values(response.pagesCached)
          .map((page) => page.timestamp)
          .filter((ts) => ts);
        if (timestamps.length > 0) {
          const earliestTimestamp = Math.min(...timestamps);
          const cacheDate = new Date(earliestTimestamp);
          const formattedDate = cacheDate.toLocaleString();
          cacheTimeInfo = `<div class="cache-time">Cached on: ${formattedDate}</div>`;
        }
      }
      cacheInfo.innerHTML = `
        <div>
          <span>${CONSTANTS.TEXT.USING_CACHE} ${response.orderNumbers.length} ${CONSTANTS.TEXT.ORDERS} ${cachePages} ${CONSTANTS.TEXT.PAGES}</span>
          ${cacheTimeInfo}
        </div>
      `;
      // Add cache info to the UI
      const cardClass = document.querySelector(".card"); 
      cardClass.appendChild(cacheInfo);
      // Show rating hint
      if (response.orderNumbers.length > 4) {
        maybeShowRatingHint();
      }
    }
  });
}
function updateProgress() {
  chrome.runtime.sendMessage({ action: "getProgress" }, function (response) {
    if (response.isCollecting) {
      updateProgressUI(response.currentPage, response.pageLimit, true);
      displayOrderNumbers(response.orderNumbers, response.additionalFields);
      setTimeout(updateProgress, 1000);
      // set all checkboxes to disabled
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach((cb) => (cb.disabled = true));
    } else {
      updateProgressUI(response.currentPage, response.pageLimit, false);
      displayOrderNumbers(response.orderNumbers, response.additionalFields);
      document.getElementById("startCollection").style.display = "inline-flex";
      document.getElementById("stopCollection").style.display = "none";
      document.getElementById("startCollection").querySelector(".btn-text").textContent = "Start Collection";
      // set all checkboxes to enabled
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach((cb) => (cb.disabled = false));
    }
  });
}
function updateProgressUI(currentPage, pageLimit, inProgress) {
  const progressElement = document.getElementById("progress") || createProgressElement();
  const pageLimitText = pageLimit > 0 ? ` of ${pageLimit}` : "";
  document.getElementById("progress").style.display = "block";
  if (inProgress) {
    console.log("Progress:", currentPage, pageLimit);
    progressElement.innerHTML = `
      <span class="loading-spinner" style="border-color: var(--primary); border-top-color: transparent;"></span>
      Fetching order numbers... Fetching Page ${currentPage}${pageLimitText} 
    `;
  } else {
    progressElement.textContent = `Collection ${pageLimit > 0 && currentPage >= pageLimit ? "reached limit" : "completed"}. Total pages: ${
      pageLimit > 0 ? currentPage : currentPage - 1
    }`;
  }
}
function createProgressElement() {
  const progressElement = document.createElement("div");
  progressElement.id = "progress";
  document.body.insertBefore(progressElement, document.getElementById("orderNumbersContainer"));
  return progressElement;
}
function updateCheckboxCount(container) {
  const heading = container.querySelector("h3");
  const total = container.querySelectorAll('input[type="checkbox"]:not(#selectAll)').length;
  const checked = container.querySelectorAll('input[type="checkbox"]:not(#selectAll):checked').length;
  const totalOrders = container.querySelectorAll('input[type="checkbox"]:not(#selectAll)').length;
  heading.textContent = `${CONSTANTS.TEXT.SELECT_ORDERS} (${totalOrders}) - Selected: ${checked}`;
}
async function displayOrderNumbers(orderNumbers, additionalFields = {}) {
  const container = document.getElementById("orderNumbersContainer");
  container.innerHTML = `<h3>${CONSTANTS.TEXT.SELECT_ORDERS} (${orderNumbers.length}) - Selected: 0</h3>`;
  // Get cached order numbers
  const cachedOrders = await getCachedOrderNumbers();
  const cachedSet = new Set(cachedOrders);
  // Create select all checkbox
  const selectAllDiv = document.createElement("div");
  selectAllDiv.className = CONSTANTS.CSS_CLASSES.CHECKBOX_CONTAINER;
  const selectAll = document.createElement("input");
  selectAll.type = "checkbox";
  selectAll.id = "selectAll";
  const selectAllLabel = document.createElement("label");
  selectAllLabel.htmlFor = "selectAll";
  selectAllLabel.appendChild(document.createTextNode(CONSTANTS.TEXT.SELECT_ALL));
  selectAllDiv.appendChild(selectAll);
  selectAllDiv.appendChild(selectAllLabel);
  container.appendChild(selectAllDiv);
  // Create order list container with scrollable area
  const orderList = document.createElement("div");
  orderList.style.maxHeight = "150px";
  orderList.style.overflowY = "auto";
  orderList.style.marginBottom = "16px";
  // Add individual order checkboxes with cache icons
  orderNumbers.forEach((orderNumber) => {
    const tooltip = additionalFields && additionalFields[orderNumber] ? additionalFields[orderNumber] : null;
    const checkboxDiv = createCheckboxElement({
      id: orderNumber,
      value: orderNumber,
      label: `${CONSTANTS.TEXT.ORDER_PREFIX}${orderNumber}`,
      tooltip: tooltip,
    });
    // Add cache indicator if cached
    if (cachedSet.has(orderNumber)) {
      const cacheIndicator = document.createElement("span");
      cacheIndicator.style.cssText = 'cursor: pointer; margin-left: 6px; color: var(--primary); display: inline-flex; align-items: center; gap: 2px; font-size: 10px;';
      cacheIndicator.title = 'Click to delete this order\'s cache';
      cacheIndicator.innerHTML = renderIcon('CACHE', 'var(--primary)');
      cacheIndicator.style.display = 'inline-flex';
      cacheIndicator.addEventListener('click', async (e) => {
        e.stopPropagation();
        await deleteInvoiceCache(orderNumber);
        cachedSet.delete(orderNumber);
        cacheIndicator.style.display = 'none';
      });
      checkboxDiv.appendChild(cacheIndicator);
    }
    orderList.appendChild(checkboxDiv);
  });
  container.appendChild(orderList);
  // Add select all functionality
  selectAll.addEventListener("change", function () {
    toggleAllCheckboxes(orderList, selectAll.checked);
    updateCheckboxCount(container);
  });
  // Update count on individual checkbox changes
  orderNumbers.forEach((orderNumber) => {
    const checkbox = container.querySelector(`input[value="${orderNumber}"]`);
    if (checkbox) {
      checkbox.addEventListener("change", () => updateCheckboxCount(container));
    }
  });
  // Add download button if there are order numbers
  if (orderNumbers.length > 0 && !document.getElementById("downloadButton")) {
    const downloadButton = document.createElement("button");
    downloadButton.id = "downloadButton";
    downloadButton.className = CONSTANTS.CSS_CLASSES.BTN_SUCCESS;
    const label = exportMode === CONSTANTS.EXPORT_MODES.SINGLE ? 'Download as Single File' : 'Download Selected Orders';
    downloadButton.innerHTML = `
      ${renderIcon('DOWNLOAD')}
      ${label}
    `;
    downloadButton.addEventListener("click", downloadSelectedOrders);
    container.appendChild(downloadButton);
  }
}
async function downloadSelectedOrders() {
  if (downloadInProgress) {
    alert("Downloads are already in progress. Please wait.");
    return;
  }
  const selectedOrders = getSelectedOrderNumbers();
  if (selectedOrders.length === 0) {
    alert("Please select at least one order to download.");
    return;
  }
  const downloadButton = document.getElementById("downloadButton");
  downloadButton.disabled = true;
  setButtonLoading(downloadButton, true);
  downloadInProgress = true;
  const failedOrders = [];
  // Route based on export mode
  if (exportMode === CONSTANTS.EXPORT_MODES.SINGLE) {
    try {
      await downloadCombinedSelectedOrders(selectedOrders, failedOrders);
    } catch (e) {
      console.error('Combined export failed:', e);
      alert('An error occurred creating the combined spreadsheet.');
    } finally {
      downloadButton.disabled = false;
      setButtonLoading(downloadButton, false);
      downloadInProgress = false;
    }
    return;
  }
  // Multiple files flow (existing)
  let downloadTab = null;
  // Helper function to attempt download with specific URL
  async function attemptDownload(orderNumber, url, attempt) {
    try {
      // Check cache first - if cached, use it and create Excel file directly
      const cachedData = await getCachedInvoice(orderNumber);
      if (cachedData) {
        console.log(`Using cached data for order ${orderNumber}`);
        // Convert cached data to Excel directly without opening tab
        convertToXlsx(cachedData, ExcelJS, { mode: 'single' });
        return true;
      }
      // Not cached, so fetch from page
      // Create or reuse tab
      if (!downloadTab) {
        downloadTab = await new Promise((resolve) => {
          chrome.tabs.create({ url: url, active: false }, resolve);
        });
      } else {
        await new Promise((resolve) => {
          chrome.tabs.update(downloadTab.id, { url: url }, resolve);
        });
      }
      // Wait for page load and trigger download with timeout
      await Promise.race([
        new Promise((resolve, reject) => {
          async function handleDownload(tabId, info) {
            if (tabId === downloadTab.id && info.status === "complete") {
              chrome.tabs.onUpdated.removeListener(handleDownload);
              try {
                // First, block images
                await new Promise((blockResolve) => {
                  chrome.tabs.sendMessage(downloadTab.id, { action: "blockImagesForDownload" }, (response) => {
                    if (chrome.runtime.lastError) {
                      console.error("Error blocking images:", chrome.runtime.lastError);
                    }
                    // Continue even if blocking fails
                    blockResolve();
                  });
                });
                // Wait a bit longer for the page to stabilize
                await new Promise((r) => setTimeout(r, 1000));
                // Get the order data and cache it
                chrome.tabs.sendMessage(downloadTab.id, { method: "getOrderData" }, async (response) => {
                  if (chrome.runtime.lastError) {
                    reject(new Error(`Failed to download order #${orderNumber}: ${chrome.runtime.lastError.message}`));
                  } else if (response && response.data) {
                    // Cache the data
                    await cacheInvoice(orderNumber, response.data);
                    // Convert to Excel
                    convertToXlsx(response.data, ExcelJS, { mode: 'single' });
                    resolve();
                  } else {
                    reject(new Error(`No data received for order #${orderNumber}`));
                  }
                });
              } catch (error) {
                reject(error);
              }
            }
          }
          chrome.tabs.onUpdated.addListener(handleDownload);
        }),
        new Promise((_, reject) => setTimeout(() => reject(new Error(`Timeout downloading order #${orderNumber}`)), CONSTANTS.TIMING.DOWNLOAD_TIMEOUT)),
      ]);
      return true; // Download successful
    } catch (error) {
      console.error(`Error downloading order #${orderNumber} (attempt ${attempt}):`, error);
      return false; // Download failed
    }
  }
  try {
    // Create progress indicator
    const progressDiv = document.createElement("div");
    progressDiv.id = "downloadProgress";
    document.getElementById("progress").style.display = "none";
    document.getElementById("progress").insertAdjacentElement("afterend", progressDiv);
    for (let i = 0; i < selectedOrders.length; i++) {
      const orderNumber = selectedOrders[i];
      progressDiv.innerHTML = createProgressMessage(
        i + 1,
        selectedOrders.length,
        CONSTANTS.TEXT.DOWNLOADING,
        orderNumber
      );
      let downloadSuccess = false;
      const isLongOrderNumber = orderNumber.length >= 20;
      // First attempt with default parameter based on order number length
      let firstAttemptUrl = `${CONSTANTS.URLS.WALMART_ORDERS}/${orderNumber}${isLongOrderNumber ? "?storePurchase=true" : ""}`;
      downloadSuccess = await attemptDownload(orderNumber, firstAttemptUrl, 1);
      // If first attempt fails, try with opposite parameter
      if (!downloadSuccess) {
        progressDiv.innerHTML = createProgressMessage(
          i + 1,
          selectedOrders.length,
          CONSTANTS.TEXT.RETRY_PREFIX,
          orderNumber
        );
        let secondAttemptUrl = `${CONSTANTS.URLS.WALMART_ORDERS}/${orderNumber}${isLongOrderNumber ? "" : "?storePurchase=true"}`;
        downloadSuccess = await attemptDownload(orderNumber, secondAttemptUrl, 2);
      }
      // If both attempts fail, add to failed orders
      if (!downloadSuccess) {
        failedOrders.push(orderNumber);
      }
      await delay(500);
    }
    // Cleanup
    if (downloadTab) {
      chrome.tabs.remove(downloadTab.id);
    }
    // Show completion message with failed orders if any
    if (failedOrders.length === 0) {
      progressDiv.innerHTML = createSuccessMessage('All downloads completed successfully!');
    } else {
      progressDiv.innerHTML = createErrorMessage(
        `Downloads completed with ${failedOrders.length} failed orders:<br>Failed orders: ${failedOrders.map((order) => `#${order}`).join(", ")}`
      );
    }
    setTimeout(() => progressDiv.remove(), failedOrders.length > 0 ? 30000 : 10000);
    // Show rating hint
    if (failedOrders.length === 0) {
      maybeShowRatingHint();
    }
  } catch (error) {
    console.error("Download error:", error);
    alert("An error occurred during download process. Some orders may have failed.");
    if (downloadTab) {
      chrome.tabs.remove(downloadTab.id);
    }
  } finally {
    downloadButton.disabled = false;
    setButtonLoading(downloadButton, false);
    downloadInProgress = false;
  }
}
// Combined export: build one workbook in popup with ExcelJS
async function downloadCombinedSelectedOrders(selectedOrders, failedOrders) {
  // Create progress indicator
  const progressDiv = document.createElement("div");
  progressDiv.id = "downloadProgress";
  document.getElementById("progress").style.display = "none";
  document.getElementById("progress").insertAdjacentElement("afterend", progressDiv);
  let downloadTab = null;
  const collectedOrdersData = [];
  // Helper to navigate and get data with retry for storePurchase param
  const getDataForOrder = async (orderNumber, attempt = 1) => {
    // Check cache first
    const cachedData = await getCachedInvoice(orderNumber);
    if (cachedData) {
      console.log(`Using cached data for order ${orderNumber}`);
      return cachedData;
    }
    const isLongOrderNumber = orderNumber.length >= 20;
    const firstAttemptUrl = `https://www.walmart.com/orders/${orderNumber}${isLongOrderNumber ? "?storePurchase=true" : ""}`;
    const secondAttemptUrl = `https://www.walmart.com/orders/${orderNumber}${isLongOrderNumber ? "" : "?storePurchase=true"}`;
    const tryUrl = async (url) => {
      // Create or reuse tab
      if (!downloadTab) {
        downloadTab = await new Promise((resolve) => {
          chrome.tabs.create({ url, active: false }, resolve);
        });
      } else {
        await new Promise((resolve) => {
          chrome.tabs.update(downloadTab.id, { url }, resolve);
        });
      }
      // Wait for load and request data
      return await Promise.race([
        new Promise((resolve, reject) => {
          const handle = async (tabId, info) => {
            if (downloadTab && tabId === downloadTab.id && info.status === 'complete') {
              chrome.tabs.onUpdated.removeListener(handle);
              try {
                // Block images then request data
                await new Promise((r) => {
                  chrome.tabs.sendMessage(downloadTab.id, { action: 'blockImagesForDownload' }, () => r());
                });
                await new Promise((r) => setTimeout(r, 800));
                chrome.tabs.sendMessage(downloadTab.id, { method: 'getOrderData' }, async (resp) => {
                  if (chrome.runtime.lastError || !resp || !resp.data) {
                    reject(new Error('Failed to get data'));
                  } else {
                    // Cache the data
                    await cacheInvoice(orderNumber, resp.data);
                    resolve(resp.data);
                  }
                });
              } catch (err) {
                reject(err);
              }
            }
          };
          chrome.tabs.onUpdated.addListener(handle);
        }),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout getting data')), 30000)),
      ]);
    };
    try {
      return await tryUrl(firstAttemptUrl);
    } catch (_) {
      return await tryUrl(secondAttemptUrl);
    }
  };
  // Collect data for all selected orders
  for (let i = 0; i < selectedOrders.length; i++) {
    const orderNumber = selectedOrders[i];
    progressDiv.innerHTML = createProgressMessage(
      i + 1,
      selectedOrders.length,
      CONSTANTS.TEXT.COLLECTING,
      orderNumber
    );
    try {
      const data = await getDataForOrder(orderNumber);
      collectedOrdersData.push(data);
    } catch (e) {
      console.error('Failed to collect data for', orderNumber, e);
      failedOrders.push(orderNumber);
    }
    await delay(CONSTANTS.TIMING.RETRY_DELAY);
  }
  // Close the download tab
  if (downloadTab) {
    chrome.tabs.remove(downloadTab.id);
  }
  // Convert collected orders to XLSX using shared utility
  try {
    await convertMultipleOrdersToXlsx(collectedOrdersData, ExcelJS, 'Walmart_Orders.xlsx');
  } catch (e) {
    console.error('Failed to export to XLSX:', e);
    progressDiv.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" style="margin-right: 8px;">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      Export failed: ${e.message}
    `;
    setTimeout(() => progressDiv.remove(), 5000);
    return;
  }
  // Completion message
  if (failedOrders.length === 0) {
    progressDiv.innerHTML = createSuccessMessage(CONSTANTS.TEXT.EXPORT_SUCCESS);
  } else {
    progressDiv.innerHTML = createErrorMessage(
      `Export completed with ${failedOrders.length} failures: ${failedOrders.map((o) => `#${o}`).join(', ')}`
    );
  }
  setTimeout(() => progressDiv.remove(), failedOrders.length > 0 ? 30000 : 10000);
  if (failedOrders.length === 0) {
    maybeShowRatingHint();
  }
}
// Helper function to set loading state on any button
function setButtonLoading(button, isLoading) {
  if (isLoading) {
    button.disabled = true;
    const spinner = document.createElement("span");
    spinner.className = "loading-spinner";
    button.insertBefore(spinner, button.firstChild);
  } else {
    button.disabled = false;
    const spinner = button.querySelector(".loading-spinner");
    if (spinner) spinner.remove();
  }
}
function maybeShowRatingHint() {
  // Show 80% of the time after a successful action
  if (Math.random() > 0.8) return;
  // First check if hint has been dismissed in current session
  chrome.storage.session.get(["ratingHintDismissed"], function (sessionResult) {
    if (sessionResult.ratingHintDismissed) return;
    // Then check if hint has been dismissed 5 times in total (using local storage)
    chrome.storage.local.get(["ratingHintDismissCount"], function (localResult) {
      const dismissCount = localResult.ratingHintDismissCount || 0;
      // If dismissed 7 or more times, never show again
      if (dismissCount >= 7) return;
      // Create rating hint element if it doesn't exist
      let ratingHint = document.getElementById("ratingHint");
      if (!ratingHint) {
        ratingHint = document.createElement("div");
        ratingHint.id = "ratingHint";
        ratingHint.className = "rating-hint";
        ratingHint.innerHTML = `
        <a href="${CONSTANTS.URLS.WALMART_REVIEWS}" target="_blank">
          ${renderIcon('STAR')}
          Find this helpful? Consider rating it
        </a>
        <button class="dismiss-hint" title="Don't show again">
          ${renderIcon('X_CLOSE')}
        </button>
      `;
        // Add it to the UI
        const downloadButton = document.getElementById("downloadButton");
        downloadButton.insertAdjacentElement("afterend", ratingHint);
        // Handle dismiss click
        ratingHint.querySelector(".dismiss-hint").addEventListener("click", function () {
          ratingHint.classList.remove("show");
          // Update session storage for current session
          chrome.storage.session.set({ ratingHintDismissed: true });
          // Increment dismiss count in local storage
          chrome.storage.local.get(["ratingHintDismissCount"], function (result) {
            const newCount = (result.ratingHintDismissCount || 0) + 1;
            chrome.storage.local.set({ ratingHintDismissCount: newCount });
            console.log(`Rating hint dismissed ${newCount} times in total`);
          });
        });
      }
      // Show the hint
      setTimeout(() => {
        ratingHint.classList.add("show");
      }, CONSTANTS.TIMING.RATING_DELAY);
    });
  });
}
</file>

</files>
